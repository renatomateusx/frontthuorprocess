
<style scoped>
.card-flat {
  margin-top: 80px !important;
}
.bg-dark {
  background-color: #23b7e5 !important;
}
.btn-outline-info {
  color: white;
  border-color: white;
}
.green {
  color: green !important;
}
.holder-icon {
  left: 0;
  position: absolute;
  top: 15px;
  font-size: 22px;
}
.remove {
  position: relative;
  top: 33px;
  cursor: pointer;
}
.center {
  text-align: center;
  display: block;
}
.QuatroCincopx {
  width: 45px !important;
}
.compare {
  color: red;
  font-weight: 700;
}
.priceReal {
  color: green;
  font-weight: 700;
}
.desconto {
  color: blue;
  font-weight: 700;
}
.btnIncrementDecrement {
  height: 21px;
}
.spanIncrementDecrement {
  top: -6px;
  margin: 0 auto;
  position: relative;
}
.cursorP {
  cursor: pointer !important;
}
.btnKeepBuyingFooter {
  color: #5d9cec;
  border-color: #5d9cec;
}
.iconBadge {
  background-color: #5d9cec;
  font-size: 15px;
  color: white;
}
.iconStep {
  border-radius: 50px;
  width: 50px;
  height: 50px;
  margin: 0 auto;
  display: block;
  color: white;
  background-color: #5d9cec;
  text-align: center;
  font-size: 34px;
  margin-top: 5px;
  line-height: normal;
}
.dadosPessoais {
  font-size: 20px;
  font-weight: 900;
  top: 1px;
  position: relative;
  color: #5d9cec;
  margin-left: 10px;
}
.resumoCompra {
  font-size: 16px;
  font-weight: 900;
  top: 1px;
  position: relative;
  color: #5d9cec;
  margin-left: 10px;
}
.comandoCollapse {
  margin-left: 5px;
  top: 2px;
  position: relative;
  color: dodgerblue;
  font-size: 17px;
}
.labelForm {
  margin: 0 0 0px;

  color: #4d4d4d;
  font-weight: 700;
}
.formGroup {
  margin-bottom: 0rem;
}
.card-default {
  border-color: #5d9cec;
}
.cardSide {
  padding: 0 5px;
  box-sizing: border-box;
  border-radius: 50px;
  display: inline !important;
}
.textInformation {
  line-height: 14px;
  color: #999 !important;
  padding: 0;
  padding-left: 30px;
  float: left;
  font-size: 11px;
  margin-bottom: 10px;
}
.minusmargintop {
  margin-top: -30px !important;
}
.box-title {
  position: relative;
  padding: 0 30px 0 35px;
  box-sizing: border-box;
}
.card-default {
  border-radius: 7px;
}
.btnContinue {
  height: 50px;
  font-size: 20px;
  border-radius: 10px;
}
.rounded {
  border-radius: 7px !important;
}
.disabledBox {
  cursor: default;
  pointer-events: none;
  -moz-opacity: 0.6;
  -khtml-opacity: 0.6;
  -webkit-opacity: 0.6;
  opacity: 0.6;
}
.paddingZero {
  padding: 0;
}
.localidade {
  top: 5px !important;
  font-size: 12px;
}
.dadosPessoaisNomeCompletoVModel {
  color: #4d4d4d !important;
  font-weight: 700 !important;
  font-size: 15px;
}
.paddingTopBottomZERO {
  padding-bottom: 0px !important;
  padding-top: 0px !important;
}
.enderecoEntregaHeader {
  font-size: 15px;
  font-weight: 700;
  color: grey;
}
.opcaoSelecionada {
  background-color: #dcdcdc;
  color: black;
  font-weight: bold;
  border-color: #dcdcdc;
  border: 2px solid #ccc;
}
.opcaoDeselecionada {
  font-weight: bold;
  color: gray;
  border-color: 2px solid #23b7e5;
}
.btnFrete {
  padding: 15px;
  margin: 10px;
  cursor: pointer !important;
  border-radius: 10px;
}
.btnFormaPagamentoSelecionada {
  padding: 5px;
  margin: 5px;
  cursor: pointer !important;
  border-radius: 10px;
  margin: 0 auto!important;
  margin-bottom: 10px!important;
}
.smallInforFormaPagamentoBoleto {
  padding: 5px;
  margin: 5px;
  cursor: pointer !important;
  border-radius: 10px;
  color: black;
  background-color: #dcdcdc;
  border: 2px solid #ccc;
}
.selecionadoInfo {
  margin-top: 10px;
  color: blueviolet;
  text-align: right !important;
  float: right !important;
}
.ValorTotalResumo {
  background-color: #f5f5f5;
  border-radius: 9px;
  height: 40px;
  color: white !important;
}
.textValorTotal {
  color: black;
  font-weight: 700;
  font-size: 1.2em;
  display: block;
  margin: 0 auto;
  text-align: center;
  top: 5px;
  float: left !important;
}
.textItems {
  color: black;
  margin-bottom: 5px !important;
}
.imgVariant {
  width: 50px;
  height: 50px;
  top: 7px;
  position: relative;
}
.textInfoFrete {
  text-align: left;
  font-size: 11px;
  white-space: pre-wrap;
}
.imageCard {
  /*width: 25px !important;*/
  height: 25px !important;
}
.valorTotalCollapse {
  font-weight: 700;
  color: #3fc583 !important;
  font-size: 15px;
}
.hidden {
  display: none !important;
}
@media only screen and (max-width: 992px) {
  #btnTop {
    display: block !important;
  }
  .valorTotalCollapse {
    font-weight: 700;
    color: #3fc583 !important;
    font-size: 11px !important;
    top: 3px !important;
    position: relative;
  }
  .resumoCompra {
    font-size: 13px !important;
  }
  .comandoCollapse {
    margin-left: 5px;
    top: 0px !important;
    position: relative;
    color: dodgerblue;
    font-size: 15px !important;
  }
}
@media only screen and (max-width: 767px) {
  .QuatroCincopx {
    margin-left: 0px !important;
  }
  .remove {
    float: left;
    left: 60px;
    position: relative;
    top: -54px;
    cursor: pointer;
    font-size: 25px;
  }
  .valorTotalCollapse {
    font-weight: 700;
    color: #3fc583;
    font-size: 11px !important;
    top: 3px !important;
    position: relative;
  }
  .resumoCompra {
    font-size: 13px !important;
  }
  .comandoCollapse {
    margin-left: 5px;
    top: 0px !important;
    position: relative;
    color: dodgerblue;
    font-size: 15px !important;
  }
  .textItems {
    position: relative;
    top: 0px !important;
  }
}
</style>
<template>
  <div class="block-center">
    <div class="container-fluid">
      <div class="card shopping-cart mb-0">
        <div class="card-header bg-dark text-light">
          {{getNomeLoja() || 'Thuor.com'}}
          <!-- <div class="clearfix"></div> -->
          <div class="item-security pull-right float-right black-70 ml30 row" aria-hidden="true">
            <div class="holder-icon col-md-2" style="display:none;">
              <div class="fa fa-lock"></div>
              <!-- /.icon -->
            </div>
            <!-- /.holder-icon -->
            <div class="text mr-2">
              <div class="fa fa-lock"></div>
              <strong class="ml-1">Pagamento</strong>
              <br />
              <strong class="green">100% seguro</strong>
            </div>
            <!-- /.text -->
          </div>
        </div>
        <span class></span>
        <div class="badge badge-blue iconStep" style="display:none;">1</div>
      </div>
      <div class="row col-lg-4 col-lg-offset-2" style=" margin: 0 auto; display:block">
        <up-sell-card @recalcula="getTotal()" :noCheckout="1"></up-sell-card>
        <!-- START STEP 4-->
        <div class="col-md-4 mt-0 mb-0 cardSide">
          <!-- START card-->
          <div class="card card-default mb-0">
            <div class="card-header rounded">
              <a
                style="cursor:pointer!important;"
                data-toggle="collapse"
                aria-expanded="false"
                aria-controls="collapseResumo"
                v-on:click="collapse('#collapseResumo','#comandoCollapse')"
              >
                <span
                  id="collapseParent"
                  class="resumoCompra pull-left float-left ml-0"
                  role="button"
                >Resumo</span>
                <small
                  style="cursor:pointer!important;"
                  class="ml-2 text-left textItems"
                >{{totalQuantity}} Item(ns)</small>
                <small class="valorTotalCollapse pull-right float-right">
                  R$ {{this.formatPrice(granTotal)}}
                  <span
                    class="fa fa-arrow-down comandoCollapse pull-right float-right"
                    id="comandoCollapse"
                    role="button"
                  ></span>
                </small>
              </a>

              <div class="col-lg-12 collapse" id="collapseResumo" data-parent="#collapseParent">
                <div class="col-md-12 ValorTotalResumo mt-3">
                  <span class="textValorTotal col-md-12">Valor: R$ {{this.formatPrice(granTotal)}}</span>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="items">
                      <div
                        class="product"
                        v-for="{title, variant_id, variant_title, quantity, variant_price_ancora, variant_price, variant_img, id_thuor} in getProdutosCart()"
                        :key="id_thuor"
                      >
                        <div class="row col-md-12">
                          <div class="mt-2 w-100">
                            <img class="rounded img-fluid float-left imgVariant" :src="variant_img" />
                            <div class="product-name">
                              <div class="product-name">
                                <a class="ml-2 w-100" href="#">{{title}}</a>
                                <div class="product-info">
                                  <div>
                                    <span class="value ml-2">{{variant_title}}</span>
                                  </div>
                                </div>
                                <div class="product-info">
                                  <div>
                                    <span class="value ml-2">
                                      <small>
                                        {{quantity}} Unidade(s) -
                                        <b>R$ {{formatPrice(variant_price)}}</b>
                                      </small>
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                        <hr />
                      </div>
                    </div>
                  </div>
                  <!-- CUPOM CARD -->
                  <cupom-card @recalcula="getTotal()"></cupom-card>
                </div>
              </div>
            </div>
            <div class="card-body minusmargintop"></div>
          </div>
          <!-- END card-->
        </div>
        <!-- END STEP 4-->
        <!-- START STEP 1-->
        <form class="form-horizontal" id="formCheckout">
          <div class="col-md-4 col-xl-4 mt-0 mb-0 cardSide">
            <!-- START card-->
            <div class="card card-default mb-0">
              <div class="card-header rounded">
                <span class="badge badge-blue iconBadge">1</span>
                <span class="dadosPessoais">Dados Pessoais</span>
                <span
                  class="fa fa-edit pull-right float-right cursorP"
                  v-show="this.getStepDadosPessoaisFinalizados()"
                  v-on:click="editarDadosPessoais()"
                ></span>
                <p>
                  <small
                    class="textInformation col-md-10"
                  >Solicitamos somente as informações essenciais para você fazer sua compra.</small>
                </p>
              </div>
              <div class="card-body minusmargintop" v-show="this.getStepDadosPessoaisFinalizados()">
                <div class="form-group row formGroup">
                  <label
                    class="col-xl-12 col-form-label labelForm dadosPessoaisNomeCompletoVModel paddingTopBottomZERO"
                    v-show="nome_completo"
                  >{{nome_completo}}</label>
                  <label
                    class="col-xl-12 col-form-label labelForm paddingTopBottomZERO"
                    v-show="email"
                  >{{email}}</label>
                  <label
                    class="col-xl-12 col-form-label labelForm paddingTopBottomZERO"
                    v-show="cpf"
                  >CPF: {{cpf}}</label>
                </div>
              </div>
              <div
                class="card-body minusmargintop"
                v-show="!this.getStepDadosPessoaisFinalizados()"
              >
                <div class="form-group row formGroup">
                  <label class="col-xl-12 col-form-label labelForm">Nome Completo</label>
                  <div class="col-xl-12">
                    <input
                      class="form-control required"
                      autocomplete="name"
                      type="text"
                      minlength="5"
                      v-model.lazy="nome_completo"
                      id="nome_completo"
                      placeholder="Digite seu nome aqui"
                      required
                    />
                  </div>
                </div>
                <div class="form-group row formGroup">
                  <label class="col-md-10 col-form-label labelForm">E-mail</label>
                  <div class="col-xl-12">
                    <input
                      autocomplete="email"
                      class="form-control"
                      type="email"
                      v-model.lazy="email"
                      id="email_user"
                      placeholder="Digite seu E-mail"
                      required
                    />
                  </div>
                </div>
                <div class="form-group row formGroup">
                  <label class="col-xl-12 col-form-label labelForm">CPF</label>
                  <div class="col-md-7">
                    <input
                      @input="maskCPF()"
                      @focus="saveLead()"
                      minlength="14"
                      maxlength="14"
                      class="form-control required"
                      autocomplete="cpf"
                      type="text"
                      v-model="cpf"
                      placeholder="Digite seu CPF"
                      required
                    />
                  </div>
                </div>
                <div class="form-group row formGroup">
                  <label
                    class="col-xl-12 col-form-label labelForm"
                    for="inlineFormInputGroup"
                  >Celular / WhatsApp</label>
                  <div class="col-xl-7 col-md-9">
                    <div class="input-group mb-0">
                      <div class="input-group-prepend">
                        <div class="input-group-text">+55</div>
                      </div>
                      <input
                        class="form-control"
                        id="inlineFormInputGroup"
                        type="text"
                        minlength="15"
                        maxlength="15"
                        @input="maskTelefone()"
                        v-model="telefone"
                        placeholder="71 9 9130-6561"
                        required
                      />
                    </div>
                  </div>
                </div>

                <div class="form-group row mt-3">
                  <div class="col-xl-12">
                    <button
                      class="btn btn-sm btn-primary btn-lg btn-block float-right mb-0 btnContinue"
                      v-on:click="validarStep(currentStep)"
                      type="button"
                    >
                      Continuar
                      <span
                        class="fa fa-arrow-right ml-2"
                        style="position:relative; top:1px"
                      ></span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- END card-->
          </div>
          <!-- END STEP 1-->
          <!-- START STEP 2-->
          <div
            class="col-md-4 mt-0 mb-0 cardSide"
            v-bind:class="currentStep == 2 || getStepDadosEnderecoFinalizado() == 1 ? '': 'disabledBox'"
          >
            <!-- START card-->
            <div class="card card-default mb-0">
              <div class="card-header rounded">
                <span class="badge badge-blue iconBadge">2</span>
                <span class="dadosPessoais">Entrega</span>
                <span
                  class="fa fa-edit pull-right float-right cursorP"
                  v-show="getStepDadosEnderecoFinalizado() == 1"
                  v-on:click="editarEndereco()"
                ></span>
                <p>
                  <small
                    class="textInformation col-md-10"
                  >Cadastre ou selecione um endereço para receber sua encomenda.</small>
                </p>
              </div>
              <div
                class="card-default minusmargintop"
                v-show="getStepDadosEnderecoFinalizado() == 1"
              >
                <div class="card-body">
                  <div class="form-group row formGroup">
                    <label
                      class="col-xl-12 col-form-label labelForm enderecoEntregaHeader paddingTopBottomZERO"
                      v-show="endereco"
                    >
                      <b>Endereço de Entrega:</b>
                    </label>
                    <label
                      class="col-xl-12 col-form-label labelForm paddingTopBottomZERO"
                      v-show="endereco"
                    >
                      <b>{{endereco}} - {{bairro}}</b>
                    </label>
                    <label
                      class="col-xl-12 col-form-label labelForm paddingTopBottomZERO"
                      v-show="cidade"
                    >{{cidade}}-{{estado}}</label>
                    <label
                      class="col-xl-12 col-form-label labelForm paddingTopBottomZERO"
                      v-show="CEP"
                    >CEP: {{CEP}}</label>
                  </div>
                </div>
              </div>
              <div class="card-body minusmargintop" v-show="getStepDadosEnderecoFinalizado() == 0">
                <div class="form-group row formGroup">
                  <label class="col-xl-12 col-form-label labelForm">CEP</label>
                  <div class="col-md-7">
                    <input
                      @input="consultaCEP()"
                      class="form-control required"
                      autocomplete="zipcode"
                      type="text"
                      id="cep"
                      v-model="CEP"
                      placeholder="Digite seu CEP"
                    />
                  </div>
                  <span
                    class="localidade col-md-6 pull-left float-left text-left"
                    v-show="getCidade()"
                  >{{getCidade()}} - {{getEstado()}}</span>
                </div>
                <div class="form-group row formGroup" v-show="endereco">
                  <label class="col-md-12 col-form-label labelForm">Endereço</label>
                  <div class="col-xl-12">
                    <input
                      autocomplete="address"
                      class="form-control"
                      type="address"
                      id="endereco"
                      v-model="endereco"
                      placeholder="Digite seu E-mail"
                    />
                  </div>
                </div>
                <div class="form-group row formGroup" v-show="endereco">
                  <div class="col-md-6 mt-1">
                    <label class="col-xl-12 col-form-label labelForm paddingZero mb-1">Número</label>
                    <input
                      class="form-control required"
                      autocomplete="address"
                      type="text"
                      v-model="numero_porta"
                    />
                  </div>

                  <div class="col-md-6 mt-1" v-show="bairro">
                    <label class="col-xl-6 col-form-label labelForm paddingZero mb-1">Bairro</label>
                    <input
                      class="form-control required"
                      autocomplete="neighborhood"
                      type="text"
                      v-model="bairro"
                    />
                  </div>
                </div>
                <div class="form-group row formGroup" v-show="endereco">
                  <label class="col-xl-12 col-form-label labelForm">Complemento</label>
                  <div class="col-md-12">
                    <input
                      class="form-control"
                      autocomplete="complement"
                      v-model="complemento"
                      type="text"
                    />
                  </div>
                </div>
                <div class="form-group row formGroup" v-show="endereco">
                  <label class="col-xl-12 col-form-label labelForm">Destinatário</label>
                  <div class="col-md-12">
                    <input
                      class="form-control"
                      autocomplete="receiver"
                      v-model="destinatario"
                      type="text"
                    />
                  </div>
                </div>

                <div class="form-group row mt-3">
                  <div class="col-xl-12">
                    <button
                      class="btn btn-sm btn-primary btn-lg btn-block float-right mb-0 btnContinue"
                      v-on:click="validarStep(currentStep)"
                      type="button"
                    >
                      Continuar
                      <span
                        class="fa fa-arrow-right ml-2"
                        style="position:relative; top:1px"
                      ></span>
                    </button>
                  </div>
                </div>
              </div>
              <!-- stepDadosEnderecoFinalizados == 1 &&  -->
              <div
                class="card-default minusmargintop"
                v-show="getStepDadosEnderecoFinalizado() == 1 && ifGetFretes()"
                v-for="{id, status, nome, prazo, preco } in getFretes()"
                :key="id"
              >
                <div class="card-body">
                  <div class="form-group row formGroup">
                    <button
                      type="button"
                      v-on:click="freteSelected(id)"
                      class="btn btn-secondary col-md-11 pull-left float-left btnFrete"
                      :class="freteSelecionado == id ? 'opcaoSelecionada':'opcaoDeselecionada'"
                    >
                      <p>
                        <span
                          class="text-left pull-left float-left col-md-10 textInfoFrete"
                        >{{nome}}</span>
                      </p>
                      <p>
                        <span
                          class="text-left pull-left float-left ml-0 col-md-10 textInfoFrete"
                        >Preço: R$ {{preco}}</span>
                      </p>
                      <p>
                        <span class="text-left pull-left float-left ml-0 col-md-10">
                          <small>Entrega garantida</small>
                        </span>
                      </p>
                      <p v-if="freteSelecionado == id">
                        <span class="text-left pull-left float-left ml-0 col-md-10 selecionadoInfo">
                          <small>Selecionado</small>
                        </span>
                      </p>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <!-- END card-->
          </div>
          <!-- END STEP 2-->
          <!-- START STEP 3-->
          <div
            class="col-md-4 mt-0 mb-0 cardSide"
            v-bind:class="currentStep == 3 ? '': 'disabledBoxX'"
          >
            <!-- START card-->
            <div class="card card-default mb-0">
              <div class="card-header rounded">
                <span class="badge badge-blue iconBadge">3</span>
                <span class="dadosPessoais">Pagamento</span>
                <p>
                  <small class="textInformation col-md-10">Escolha abaixo uma forma de pagamento.</small>
                </p>
                <p class="mt-5 col-md-12">
                  <small>
                    Processado por:
                    <img
                      v-bind:src="getImageProcessor()"
                      height="20px"
                      class="imageCompanyProcessor"
                    />
                  </small>
                </p>

                <!-- MOSTRA AS OPÇÕES DE PAGAMENTO -->
                <div class="form-group row formGroup">
                  <button
                    type="button"
                    v-on:click="formaPagamentoSelecionada('creditCard')"
                    class="btn btn-secondary col-md-11 pull-left float-left btnFormaPagamentoSelecionada"
                    :class="getClassSelected('creditCard')"
                  >
                    <p>
                      <span class="text-left pull-left float-left col-md-10">Cartão de Crédito</span>
                      <span class="text-left pull-left float-left col-md-10">
                        <img
                          src="img/payment_form.png"
                          style="width: 130px!important; height: auto"
                        />
                      </span>
                    </p>
                    <p>
                      <span class="text-left pull-left float-left ml-0 col-md-10">
                        <small>Pagamento 100% seguro</small>
                      </span>
                    </p>
                    <p v-if="getFormaPagamento() == 'creditCard'">
                      <span class="text-left pull-left float-left ml-0 col-md-10 selecionadoInfo">
                        <small>Selecionado</small>
                      </span>
                    </p>
                  </button>
                  <div class="card-body minusmargintop" v-show="getFormaPagamento() =='creditCard'">
                    <div class="form-group row formGroup mt-3">
                      <label class="col-xl-12 col-form-label labelForm">
                        Número do Cartão
                        <img
                          class="imageCard"
                          v-show="getPaymentID()"
                          :src="getImageCard()"
                        />
                      </label>
                      <div class="col-md-7">
                        <input
                          @input="maskCardNumber()"
                          class="form-control required"
                          autocomplete="cc-number"
                          type="text"
                          id="card_number"
                          v-model="card_number"
                        />
                      </div>
                    </div>
                    <div class="form-group row formGroup">
                      <label class="col-xl-12 col-form-label labelForm">Validade</label>
                      <div class="col-md-5">
                        <input
                          @input="maskValidade()"
                          autocomplete="cc-exp"
                          class="form-control"
                          type="text"
                          id="validade"
                          v-model="validade"
                          placeholder="MM/AA"
                          minlength="5"
                          maxlength="5"
                        />
                      </div>
                    </div>
                    <div class="form-group row formGroup">
                      <label class="col-xl-12 col-form-label labelForm">Nome do Titular do Cartão</label>
                      <div class="col-md-7">
                        <input
                          class="form-control required"
                          v-model="nome_titular"
                          autocomplete="name"
                          type="text"
                        />
                      </div>
                    </div>
                    <div class="form-group row formGroup">
                      <label class="col-xl-12 col-form-label labelForm">Cód. de Segurança</label>
                      <div class="col-md-5">
                        <input
                          class="form-control required"
                          v-model="codigo_seguranca"
                          autocomplete="security"
                          type="text"
                        />
                      </div>
                    </div>
                    <div class="form-group row formGroup">
                      <label class="col-xl-12 col-form-label labelForm">CPF do Titular</label>
                      <div class="col-md-7">
                        <input
                          @input="maskCPFTitular()"
                          minlength="14"
                          maxlength="14"
                          class="form-control required"
                          autocomplete="cpf_titular"
                          type="text"
                          v-model="cpf_titular"
                          placeholder="Digite seu CPF"
                        />
                      </div>
                    </div>
                    <div class="form-group row formGroup">
                      <label
                        class="col-xl-2 col-form-label labelForm"
                        for="inlineFormInputGroup"
                      >Parcelas</label>
                      <div class="col-lg-12">
                        <small>Digite o cartão para selecionar as parcelas</small>
                        <select
                          id="dropParcelas"
                          v-model="parcelas"
                          class="form-control"
                          name="installments"
                          selectedIndex="0"
                        >
                          <option v-bind:value="parcelas" selected="selected"></option>
                        </select>
                      </div>
                    </div>

                    <div class="form-group row mt-3">
                      <div class="col-md-11">
                        <button
                          class="btn btn-sm btn-primary btn-lg btn-block float-right mb-0 btnContinue"
                          v-on:click="validarStep(currentStep)"
                          type="button"
                        >
                          <span class="fa fa-lock mr-2" style="position:relative; top:1px"></span>Comprar Agora
                        </button>
                      </div>
                    </div>
                  </div>
                  <button
                    type="button"
                    v-on:click="formaPagamentoSelecionada('bolbradesco')"
                    class="btn btn-secondary col-md-11 pull-left float-left btnFormaPagamentoSelecionada"
                    :class="getClassSelected('bolbradesco')"
                  >
                    <p>
                      <span class="text-left pull-left float-left col-md-10 fa fa-ticket">Boleto</span>
                      <span class="text-left pull-left float-left col-md-10">
                        <img src="img/barcode.png" style="width: 35px!important; height: auto" />
                      </span>
                    </p>
                    <p>
                      <span class="text-left pull-left float-left ml-0 col-md-10">
                        <small>Processamento em 3 dias.</small>
                      </span>
                    </p>
                    <p v-if="formaPagamento == 'bolbradesco'">
                      <span class="text-left pull-left float-left ml-0 col-md-10 selecionadoInfo">
                        <small>Selecionado</small>
                      </span>
                    </p>
                  </button>
                  <div class="card-body minusmargintop" v-show="formaPagamento =='bolbradesco'">
                    <div class="form-group row mt-2">
                      <small
                        class="text-justify col-md-11 smallInforFormaPagamentoBoleto"
                      >Somente quando recebermos a confirmação, em até 72h após o pagamento, seguiremos com o envio das suas compras. O prazo de entrega passa a ser contado somente após a confirmação do pagamento.</small>
                    </div>
                    <div class="form-group row mt-2">
                      <span class="valorNoBoleto col-md-12 ml-1">
                        Valor no Boleto
                        <strong>R$ {{formatPrice(granTotal)}}</strong>
                      </span>
                    </div>
                    <div class="form-group row mt-3">
                      <div class="col-xl-12">
                        <button
                          class="btn btn-sm btn-primary btn-lg btn-block float-right mb-0 btnContinue"
                          v-on:click="validarStep(currentStep)"
                          type="button"
                        >
                          <span class="fa fa-lock mr-2" style="position:relative; top:1px"></span>Comprar Agora
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- END card-->
          </div>
        </form>
        <!-- END STEP 3-->
      </div>
    </div>
  </div>
</template>
<script>
import Vue from "vue";
import VeeValidate from "vee-validate";
import Multiselect from "vue-multiselect";
import money from "v-money";
import API_NOTIFICATION from "../../api/notification";
import API_PRODUTOS from "../../api/produtosAPI";
import API_LOJA from "../../api/lojaAPI";
import UTILIS_API from "../../api/utilisAPI";
import API_CHECKOUT from "../../api/checkoutAPI";
import API_CHECKOUT_PAYU from "../../api/checkoutPayUAPI";
import API_FACEBOOK_PIXEL from "../../api/pixelFacebookTrigger";
import API_GOOGLE_PIXEL from "../../api/pixelGoogleTrigger";

import API_LOGIN from "../../api/loginAPI";
import API_HEADERS from "../../api/configAxios";
import UTILIS from "../../utilis/utilis.js";
import LoadScript from "vue-plugin-load-script";
import router from "../../router.js";
import Hashids from "hashids";
import dateFormat from "dateformat";
import constantes from "../../api/constantes";
import UpSellCard from "../../components/Cart/UpSellCard";
import API_CLIENTES from "../../api/clientesAPI";
import md5 from "md5";
import creditCardType from "credit-card-type";
Vue.use(LoadScript);

Vue.use(VeeValidate, {
  fieldsBagName: "formFields" // fix issue with b-table
});

Vue.component("multiselect", Multiselect);
Vue.use(money, { precision: 2 });

Vue.mixin({
  data: function() {
    return {};
  }
});

export default {
  name: "CheckoutPayU",
  created() {
    console.log("Checkout PayU ");
    if (sessionStorage.getItem("fretes") != null) {
      this.fretes = JSON.parse(sessionStorage.getItem("fretes"));
      //console.log(fretes);
    }
    API_NOTIFICATION.ShowLoading();
    this.checkURL();
  },
  components: {
    UpSellCard
  },
  computed: {},
  data() {
    return {
      price: 123.45,
      money: {
        decimal: ",",
        thousands: ".",
        prefix: " ",
        suffix: "",
        precision: 2,
        masked: false /* doesn't work with directive */
      },
      DadosCheckout: {},
      produtosCart: [],
      fretes: [],
      freteSelecionado: -1,
      dadosLoja: {},
      nomeLoja: "",
      currentStep: 1,
      nome_completo: "",
      telefone: "",
      cpf: "",
      email: "",
      CEP: "",
      endereco: "",
      numero_porta: "",
      bairro: "",
      complemento: "",
      destinatario: "",
      cidade: "",
      estado: "",
      parcelas: "",
      codigo_seguranca: "",
      cpf_titular: "",
      nome_titular: "",
      validade: "",
      cardToken: "",
      card_number: "",
      payment_id: "",
      stepDadosPessoaisFinalizados: 0,
      stepDadosEnderecoFinalizados: 0,
      valorTotalCompra: 0,
      valorFrete: 0,
      formaPagamento: "any",
      ImageProcessor: "",
      vueSelectValue: "",
      totalQuantity: 0,
      granTotal: 0,
      granDesconto: 0,
      granQuantity: 0,
      granSubTotal: 0,
      public_key: "",
      reference_id: "",
      signature: "",
      descontoCupom: 0,
    };
  },
  mounted() {},
  methods: {
    formatPrice(value) {
      let val = (value / 1).toFixed(2).replace(".", ",");
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },
    validateBeforeSubmit(scope) {
      this.$validator.validateAll(scope).then(result => {
        if (result) {
          API_NOTIFICATION.ShowLoading();
          // simulate AJAX

          return;
        }
        console.log("Correct them errors!");
      });
    },
    async checkURL() {
      var url = window.location.href;
      if (sessionStorage.getItem("DadosLoja") != null) {
        this.dadosLoja = JSON.parse(sessionStorage.getItem("DadosLoja"));
        this.getCheckouts();
        //console.log("loja", dadosLoja);
      }

      if (url.includes("items")) {
        //console.log("0");
        sessionStorage.removeItem("cart");
        var newURL = url.split("items");

        const produtos = [],
          variantes = [],
          quantidade = [];
        var params = new URL(window.location.href);
        const cart_token = params.searchParams.get("cart_token");
        const isShopify = params.searchParams.get("isShopify");
        const limpa_carrinho = params.searchParams.get("limpa_carrinho");
        const qtdItems = params.searchParams.get("qtd_items");
        const redirectTo = params.searchParams.get("redirectTo");
        this.getDadosLoja();
        for (var i = 0; i < qtdItems; i++) {
          var lpro = await this.pushProducts(
            params.searchParams.get("produto_option_id[" + i + "]"),
            params.searchParams.get("produto_option_quantity[" + i + "]"),
            params.searchParams.get("produto_option_variante_id[" + i + "]")
          );
          //console.log("LPro", lpro);
          this.produtosCart.push(lpro);
        }
        sessionStorage.setItem("cart", JSON.stringify(this.produtosCart));
        API_NOTIFICATION.HideLoading();
        //GUARDA O [1] PARA USAR COMO QUISER.
        window.location.href = newURL[0];
        if (redirectTo == "checkout") {
          router.push("/checkout");
        }
        if (redirectTo == "cart") {
          router.push("/cart");
        }
      } else {
        //console.log("1");
        const LCart = sessionStorage.getItem("cart");
        this.dadosLoja = JSON.parse(sessionStorage.getItem("DadosLoja"));
        this.produtosCart = JSON.parse(LCart);
        this.getTotal();
        API_NOTIFICATION.HideLoading();
      }
    },
    async pushProducts(product, quantity, variante_id) {
      return new Promise((resolve, reject) => {
        try {
          API_PRODUTOS.GetProdutoByIDThuor(product, quantity, variante_id)
            .then(retorno => {
              resolve(retorno.data);
            })
            .catch(error => {
              console.log("Error ao pegar o Produto no Thuor.com", error);
            });
        } catch (error) {
          console.log("Erro ao pegar os dados do produto na API", error);
        }
      });
    },
    async remove(id) {
      for (var i = 0; i < this.produtosCart.length; i++) {
        if (this.produtosCart[i].id_thuor == id) {
          this.produtosCart.splice(i, 1);
          sessionStorage.setItem("cart", JSON.stringify(this.produtosCart));
          this.getTotal();
        }
      }
    },
    async getDadosLoja() {
      //API_NOTIFICATION.ShowLoading();
      var params = new URL(window.location.href);
      const store = params.searchParams.get("store");
      API_LOJA.GetDadosLoja(store)
        .then(res => {
          const LojaData = res.data;
          this.dadosLoja = LojaData;
          sessionStorage.setItem("DadosLoja", JSON.stringify(this.dadosLoja));
        })
        .catch(error => {
          console.log("Erro ao pegar dados da Loja", error);
        });
    },
    getNomeLoja() {
      return this.dadosLoja.nome_loja;
    },
    getNomeFatura() {
      return this.DadosCheckout.nome_fatura || this.getNomeLoja();
    },
    async changeQuantity(idThuor) {
      var Comp = document.getElementById("qtd_" + idThuor);
      for (const [i, item] of this.produtosCart.entries()) {
        if (item.id_thuor == idThuor) {
          item.quantity = Comp.value;
          this.produtosCart[i].quantity = Comp.value;
          sessionStorage.setItem("cart", JSON.stringify(this.produtosCart));
          this.getTotal();
          break;
        }
      }
    },
    incrementaQuantidade(idThuor) {
      var Comp = document.getElementById("qtd_" + idThuor);
      var qtd = parseInt(Comp.value) + 1;
      document.getElementById("qtd_" + idThuor).value = qtd;
      this.changeQuantity(idThuor);
    },
    decrementaQuantidade(idThuor) {
      var Comp = document.getElementById("qtd_" + idThuor);
      var qtd = parseInt(Comp.value) - 1;
      document.getElementById("qtd_" + idThuor).value = qtd;
      this.changeQuantity(idThuor);
    },
    goToCheckout() {
      router.push("/checkout");
    },
    consultaCEP() {
      if (this.CEP.length >= 8) {
        API_NOTIFICATION.ShowLoading();
        this.CEP = this.CEP.replace(/(\d{5})(\d{3})/, "$1-$2");
        UTILIS_API.VIA_CEP(this.CEP)
          .then(retornoCEP => {
            this.endereco = retornoCEP.logradouro;
            this.bairro = retornoCEP.bairro;
            this.cidade = retornoCEP.localidade;
            this.estado = retornoCEP.uf;
            this.complemento = retornoCEP.complemento;
            this.destinatario = this.nome_completo;
            API_NOTIFICATION.HideLoading();
          })
          .catch(error => {
            this.endereco = "";
            this.bairro = "";
            this.cidade = "";
            this.estado = "";
            this.complemento = "";
            this.destinatario = "";
            console.log(
              "Erro ao tentar pegar dados do endereço do usuário",
              error
            );
            API_NOTIFICATION.HideLoading();
          });
      } else {
        this.endereco = "";
        this.bairro = "";
        this.cidade = "";
        this.estado = "";
        this.complemento = "";
        this.destinatario = "";
      }
    },
    validarStep(step) {
      API_NOTIFICATION.ShowLoading();
      if (this.currentStep == 1) {
        if (
          UTILIS.isValidName(this.nome_completo) &&
          UTILIS.isValidEmail(this.email) &&
          UTILIS.isValidCPF(this.cpf) &&
          UTILIS.isValidTelefone(this.telefone)
        ) {
          this.nome_completo = this.nome_completo.toUpperCase();
          this.stepDadosPessoaisFinalizados = 1;
          this.currentStep = 2;
          this.saveLead();
          API_NOTIFICATION.HideLoading();
        }
      } else if (this.currentStep == 2) {
        if (
          UTILIS.isValidString(this.CEP, 9, "CEP") &&
          UTILIS.isValidString(this.endereco, 5, "Endereço") &&
          UTILIS.isValidString(this.numero_porta, 1, "Número do endereço") &&
          UTILIS.isValidString(this.bairro, 2, "bairro") &&
          UTILIS.isValidString(this.destinatario, 5, "destinatário")
        ) {
          API_LOJA.GetFretes()
            .then(retornoFretes => {
              sessionStorage.setItem(
                "fretes",
                JSON.stringify(retornoFretes.data)
              );
              this.fretes = retornoFretes.data;
              retornoFretes.data.forEach((obj, i) => {
                this.selecionaPadrao(obj.id, obj.preco, obj.nome);
              });
              this.stepDadosEnderecoFinalizados = 1;
              this.currentStep = 3;
              API_NOTIFICATION.HideLoading();
            })
            .catch(error => {
              console.log(
                "Não foi possível obter os dados do Frete para esta loja",
                error
              );
            });
        }
      } else if (this.currentStep == 3) {
        ///Verifica se o gateway é o MERCADO PAGO
        if (this.DadosCheckout.gateway == 3) {
          this.pay();
        }
      }
    },
    editarDadosPessoais() {
      this.stepDadosPessoaisFinalizados = 0;
      document.getElementById("nome_completo").focus();
      this.currentStep = 1;
    },
    editarEndereco() {
      this.stepDadosEnderecoFinalizados = 0;
      document.getElementById("cep").focus();
      this.currentStep = 2;
    },
    maskCPF() {
      this.cpf = this.cpf.replace(
        /(\d{3})(\d{3})(\d{3})(\d{2})/,
        "$1.$2.$3-$4"
      );
    },
    maskCPFTitular() {
      this.cpf_titular = this.cpf_titular.replace(
        /(\d{3})(\d{3})(\d{3})(\d{2})/,
        "$1.$2.$3-$4"
      );
    },
    maskTelefone() {
      this.telefone = this.telefone.replace(
        /(\d{2})(\d{5})(\d{4})/,
        "($1) $2-$3"
      );
    },
    maskCardNumber() {
      if (this.payment_id == "amex") {
        this.card_number = this.card_number.replace(
          /(\d{4})(\d{4})(\d{4})(\d{3})/,
          "$1 $2 $3 $4"
        );
      } else {
        this.card_number = this.card_number.replace(
          /(\d{4})(\d{4})(\d{4})(\d{4})/,
          "$1 $2 $3 $4"
        );
      }
    },
    maskValidade() {
      this.validade = this.validade.replace(/(\d{2})(\d{2})/, "$1/$2");
    },
    freteSelected(id) {
      this.freteSelecionado = id;
      var lnome = this.fretes.find(x => x.id == this.freteSelecionado).nome;
      this.valorFrete = parseFloat(
        this.fretes.find(x => x.id == this.freteSelecionado).preco
      );
      this.getTotal();
    },
    selecionaPadrao(id, preco, nome) {
      if (
        preco == "0,00" ||
        nome
          .toUpperCase()
          .includes("GRÁTIS" || nome.toUpperCase().includes("GRATIS"))
      ) {
        this.freteSelected(id);
      }
      return true;
    },
    getFreteSelecionadoNome() {
      var lnome = this.fretes.find(x => x.id == this.freteSelecionado).nome;
      //console.log("Nome Selecionado", lnome);
      return lnome;
    },
    getImageProcessor() {
      return this.ImageProcessor;
    },
    formaPagamentoSelecionada(fmp) {
      this.formaPagamento = fmp;
      this.payment_id = fmp;
      API_FACEBOOK_PIXEL.TriggerFacebookEvent("AddPaymentInfo");
      API_GOOGLE_PIXEL.TriggerGoogleEvent("add_payment_info");
    },
    getClassSelected(opcao) {
      return this.formaPagamento == opcao
        ? "opcaoSelecionada"
        : "opcaoDeselecionada";
    },
    collapse(id, idComando) {
      const element = document.querySelector(id);
      const elementComando = document.querySelector(idComando);
      if (element.classList.contains("show")) {
        element.classList.remove("show");
        elementComando.classList.remove("fa-arrow-up");
        elementComando.classList.add("fa-arrow-down");
      } else {
        element.classList.add("show");
        elementComando.classList.remove("fa-arrow-down");
        elementComando.classList.add("fa-arrow-up");
      }
    },
    getStepDadosPessoaisFinalizados() {
      return this.stepDadosPessoaisFinalizados;
    },
    getCheckouts() {
      API_CHECKOUT.GetCheckouts()
        .then(retornoCheckout => {
          this.DadosCheckout = retornoCheckout.data;
          if (this.DadosCheckout.gateway == 3) {
            //INSERE FORM AUXILIAR PARA ENVIAR AO MP --- ELE DEVOLVE O TOKEN
            this.iniciaCheckout();
            this.getParcelas();
          }
        })
        .catch(error => {
          console.log("Erro ao tentar pegar dados do checkout", error);
        });
    },
    getValidadeCartao() {
      var LMes = this.validade.split("/")[0];
      var LAno = this.validade.split("/")[1];
      var LVal = {
        mes: LMes,
        ano: LAno
      };
      return LVal;
    },
    getImageCard() {
      if (this.card_number.replace(/ /g, "").length > 0) {
        var bandeira =
          creditCardType(this.card_number.replace(/ /g, ""))[0].type || "";
        if (
          bandeira == "maestro" ||
          bandeira == "unionpay" ||
          bandeira == "mir"
        )
          return "/img/credit-card.png";
        if (bandeira == "diners-club") bandeira = "diners";
        if (bandeira == "american-express") bandeira = "amex-american-express";
        if (bandeira != "") {
          return (
            "http://github.bubbstore.com/formas-de-pagamento/" +
              bandeira +
              ".svg" || "/img/credit-card.png"
          );
        } else {
          return "img/credit-card.png";
        }
      } else {
        return "img/credit-card.png";
      }
    },
    // verificaDigitosCartao() {
    //   if (this.DadosCheckout.gateway == 1) {
    //     const binCard = this.card_number.replace(/ /g, "");
    //     if (binCard.length >= 6) {
    //       let bin = binCard.substring(0, 6);
    //       window.Mercadopago.getPaymentMethod(
    //         {
    //           bin: bin
    //         },
    //         (status, response) => {
    //           if (status == 200) {
    //             this.payment_id = response[0].id;
    //             if (document.getElementById("dropParcelas").length < 2) {
    //               this.getParcelas();
    //             }
    //             this.setParcelas();
    //           } else {
    //             alert(`payment method info error: ${response}`);
    //           }
    //         }
    //       );
    //     }
    //   }
    //   this.maskCardNumber();
    // },
    setPaymentMethod(status, response) {
      //console.log("Response", response);
      if (status == 200) {
        this.payment_id = response[0].id;
        this.getParcelas();
      } else {
        alert(`payment method info error: ${response}`);
      }
    },

    getStepDadosEnderecoFinalizado() {
      return this.stepDadosEnderecoFinalizados;
    },
    getCidade() {
      return this.cidade;
    },
    getEstado() {
      return this.estado;
    },
    getFormaPagamento() {
      return this.formaPagamento;
    },
    getPaymentID() {
      return this.payment_id;
    },
    getCardNumber() {
      return this.card_number;
    },
    async getTotal() {
      this.totalQuantity = 0;
      this.descontoCupom = 0;
      var subTotal = 0,
        total = 0,
        discount = 0;
      var LTotal = {
        subTotal: 0,
        total: 0,
        discount: 0
      };
      if (sessionStorage.getItem("cart") != null) {
        this.produtosCart = JSON.parse(sessionStorage.getItem("cart"));
      }
      if(sessionStorage.getItem("vld") != null){
        this.descontoCupom = parseFloat(sessionStorage.getItem("vld"));
      }
      if (this.produtosCart != null) {
        this.produtosCart.forEach((item, i) => {
          subTotal =
            parseFloat(subTotal) +
            parseFloat(item.variant_price_ancora) * parseInt(item.quantity);
          total =
            parseFloat(total) +
            parseFloat(item.variant_price) * parseFloat(item.quantity);
          this.totalQuantity =
            parseInt(this.totalQuantity) + parseInt(item.quantity);
          if (parseFloat(subTotal) > parseFloat(total)) {
            discount = parseFloat(subTotal) - parseFloat(total);
          }
          if (parseFloat(total) > parseFloat(subTotal)) {
            discount = parseFloat(total) - parseFloat(subTotal);
          }
        });
        total = parseFloat(total) - parseFloat(this.descontoCupom);
        total = parseFloat(total) + parseFloat(this.valorFrete);

        this.granSubTotal = subTotal;
        this.granDesconto = discount;
        this.granTotal = total;
        var LTotal = {
          subTotal: subTotal,
          total: total,
          discount: discount
        };
        return LTotal;
      }
    },
    getTotalQuantity() {
      return this.totalQuantity;
    },
    getProdutosCart() {
      return this.produtosCart;
    },
    ifGetFretes() {
      return this.fretes != null;
    },
    getFretes() {
      return this.fretes;
    },
    iniciaCheckout() {
      if (this.DadosCheckout.gateway == 3) {
        this.ImageProcessor = "https://github.bubbstore.com/svg/payu.svg";
      }
    },
    getParcelas() {
      var self = this;
      var arParcel = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
      document.getElementById("dropParcelas").options.length = 0;
      arParcel.forEach((obj, i) => {
        const LParcel = obj;
        let opt = document.createElement("option");
        opt.text = "Desejo dividir em " + LParcel + " Parcela(s)";
        opt.value = LParcel;
        opt.id = "parcel_" + LParcel;
        document.getElementById("dropParcelas").appendChild(opt);
      });
      setTimeout(() => {
        document.getElementById("dropParcelas").selectedIndex = 0;
        document.getElementById("dropParcelas").value = 1;
        self.parcelas = 1;
      }, 1000);
    },
    setParcelas() {
      var self = this;
      setTimeout(() => {
        document.getElementById("dropParcelas").selectedIndex = 0;
        document.getElementById("dropParcelas").value = 1;
        self.parcelas = 1;
      }, 1000);
    },
    randomString(length, chars) {
      var result = "";
      for (var i = length; i > 0; --i)
        result += chars[Math.floor(Math.random() * chars.length)];
      return result;
    },
    getSignature() {
      this.reference_id = this.randomString(
        10,
        "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
      );
      this.signature = md5(
        this.DadosCheckout.api_key +
          "~" +
          this.DadosCheckout.merchan_id +
          "~" +
          this.reference_id +
          "~" +
          this.granTotal +
          "~BRL"
      );
    },
    getDadosPagamentoTransacao() {
      this.getSignature();
      var transacao = {
        token: this.DadosCheckout.token_acesso,
        dadosComprador: {
          nome_completo: this.removeAcento(this.nome_completo),
          email: this.email,
          cpf: this.cpf,
          telefone: this.telefone,
          cep: this.CEP,
          endereco: this.removeAcento(this.endereco),
          numero_porta: this.numero_porta,
          bairro: this.bairro,
          cidade: this.cidade,
          estado: this.estado,
          complemento: this.removeAcento(this.complemento),
          destinatario: this.removeAcento(this.destinatario),
          numero_cartao: this.card_number,
          validade: this.validade,
          nome_titular: this.nome_titular,
          codigo_seguranca: this.codigo_seguranca,
          cpf_titular: this.cpf_titular,
          frete: this.getFreteSelecionadoNome(),
          valor: this.formatPrice(this.granTotal),
          forma: this.formaPagamento,
          barcode: "",
          urlBoleto: "",
          parcela: this.parcelas,
          valorParcela: "",
          bandeira: UTILIS_API.GetCardType(this.card_number.replace(/ /g, ""))
        },
        produtos: this.produtosCart,
        dadosLoja: this.dadosLoja,
        dadosCheckout: this.DadosCheckout,
        paymentData: {
          language: "pt",
          command: "SUBMIT_TRANSACTION",
          merchant: {
            apiLogin: this.DadosCheckout.api_login,
            apiKey: this.DadosCheckout.api_key
          },
          transaction: {
            order: {
              accountId: this.DadosCheckout.account_id,
              referenceCode: this.reference_id,
              description: this.getNomeFatura(),
              language: "pt",
              notifyUrl: "https://api.thuor.com/webhooks/webhookpayu",
              signature: this.signature,
              shippingAddress: {
                country: "BR"
              },
              buyer: {
                fullName: this.nome_completo,
                emailAddress: this.email,
                dniNumber: this.cpf.replace(/[-.]/g, ""),
                shippingAddress: {
                  street1: this.removeAcento(this.endereco),
                  city: this.cidade,
                  state: this.estado,
                  country: "BR",
                  postalCode: this.CEP.replace(/[-.]/g, ""),
                  phone: this.telefone.replace(/[()-]/g, "").replace(/ /g, "")
                }
              },
              additionalValues: {
                TX_VALUE: {
                  value: this.granTotal,
                  currency: "BRL"
                }
              }
            },
            creditCard: {
              number: this.card_number.replace(/ /g, ""),
              securityCode: this.codigo_seguranca,
              expirationDate:
                this.getAnoValidadeCartao() +
                "/" +
                this.getValidadeCartao().mes,
              name: this.nome_titular
            },
            type: "AUTHORIZATION_AND_CAPTURE",
            paymentMethod: UTILIS_API.GetCardType(
              this.card_number.replace(/ /g, "")
            ),
            paymentCountry: "BR",
            payer: {
              fullName: this.nome_titular,
              emailAddress: this.email
            },
            ipAddress: UTILIS_API.getIPRequest().ip,
            cookie: this.randomString(
              255,
              "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
            ),
            userAgent: navigator.userAgent.split("/")[0],
            extraParameters: {
              INSTALLMENTS_NUMBER: this.parcelas,
              RESPONSE_URL: this.dadosLoja.url_loja
            }
          },
          test: false
        }
      };
      //console.log("Transacao", transacao);
      const JSONString = JSON.stringify(transacao);
      const LCripto = btoa(JSONString);
      return LCripto;
    },
    getDadosPagamentoTransacaoBoleto() {
      this.getSignature();
      const LDaysVenceBoleto =
        this.DadosCheckout.vencimento_boleto ||
        constantes.CONSTANTE_VENCIMENTO_BOLETO;
      var LData = new Date();
      LData.setDate(LData.getDate() + LDaysVenceBoleto);
      const LDataVencimento = dateFormat(LData, "yyyy-mm-dd");

      this.DadosCheckout.chave_publica = this.public_key;
      var transacao = {
        token: this.DadosCheckout.token_acesso,
        dadosComprador: {
          nome_completo: this.removeAcento(this.nome_completo),
          email: this.email,
          cpf: this.cpf,
          telefone: this.telefone,
          cep: this.CEP,
          endereco: this.removeAcento(this.endereco),
          numero_porta: this.numero_porta,
          bairro: this.bairro,
          cidade: this.cidade,
          estado: this.estado,
          complemento: this.removeAcento(this.complemento),
          destinatario: this.removeAcento(this.destinatario),
          numero_cartao: this.card_number,
          validade: this.validade,
          nome_titular: this.nome_titular,
          codigo_seguranca: this.codigo_seguranca,
          cpf_titular: this.cpf_titular,
          frete: this.getFreteSelecionadoNome(),
          valor: this.formatPrice(this.granTotal),
          forma: this.formaPagamento,
          barcode: "",
          urlBoleto: ""
        },
        produtos: this.produtosCart,
        dadosLoja: this.dadosLoja,
        dadosCheckout: this.DadosCheckout,
        paymentData: {
          language: "pt",
          command: "SUBMIT_TRANSACTION",
          merchant: {
            apiKey: this.DadosCheckout.api_key,
            apiLogin: this.DadosCheckout.api_login
          },
          transaction: {
            order: {
              accountId: this.DadosCheckout.account_id,
              referenceCode: this.reference_id,
              description: this.getNomeFatura(),
              language: "es",
              signature: this.signature,
              notifyUrl: "https://api.thuor.com/webhooks/webhookpayu",
              additionalValues: {
                TX_VALUE: {
                  value: this.granTotal,
                  currency: "BRL"
                }
              },
              buyer: {
                fullName: this.nome_completo,
                emailAddress: this.email,
                dniNumber: this.cpf,
                shippingAddress: {
                  street1: this.removeAcento(this.endereco),
                  street2: this.complemento,
                  city: this.cidade,
                  state: this.estado,
                  country: "BR",
                  postalCode: this.CEP
                }
              }
            },
            type: "AUTHORIZATION_AND_CAPTURE",
            paymentMethod: "BOLETO_BANCARIO",
            paymentCountry: "BR",
            expirationDate: LDataVencimento,
            ipAddress: UTILIS_API.getIPRequest().ip
          },
          test: true
        }
      };
      //console.log("Transacao", transacao);
      const JSONString = JSON.stringify(transacao);
      const LCripto = btoa(JSONString);
      return LCripto;
    },
    async iniciaPagamentoBackEndBoleto() {
      API_NOTIFICATION.ShowLoading();
      var LRouter = router;

      const ParamUm = this.cpf.replace(/[.-]/g, "");
      const ParamDois = this.nome_completo.replace(/ /g, "");
      const LRefID = await this.getCripto(ParamUm, ParamUm);
      this.reference_id = LRefID;
      //console.log("Reference ID", this.reference_id);
      const LCripto = await this.getDadosPagamentoTransacaoBoleto();
      sessionStorage.setItem("LCrypto", LCripto);
      API_CHECKOUT_PAYU.DoPayBackEnd(LCripto)
        .then(retornoPayment => {
          if (
            retornoPayment.data.transactionResponse != undefined &&
            retornoPayment.data.transactionResponse.state.toUpperCase() ==
              "DECLINED"
          ) {
            API_NOTIFICATION.showNotificationW(
              "Oops!",
              "Pagamento Rejeitado. Por favor, tente novamente.",
              "error"
            );
            return;
          }
          var DadosCliente = {
            nome: this.nome_completo,
            dadosCompra: retornoPayment.data
          };
          sessionStorage.setItem("TipoCheck", "bo");
          sessionStorage.setItem("dadosCliente", JSON.stringify(DadosCliente));
          LRouter.push("/obrigado-boleto");
          API_NOTIFICATION.HideLoading();
        })
        .catch(error => {
          console.log("Erro ao efetuar o pagamento no PagSeguro", error);
        });
    },
    async iniciaPagamentoBackEndCard() {
      var LRouter = router;
      const LCripto = await this.getDadosPagamentoTransacao();
      sessionStorage.setItem("LCrypto", LCripto);
      API_CHECKOUT_PAYU.DoPayBackEnd(LCripto)
        .then(retornoPayment => {
          if (
            retornoPayment.data.transactionResponse != undefined &&
            retornoPayment.data.transactionResponse.state.toUpperCase() ==
              "DECLINED"
          ) {
            API_NOTIFICATION.showNotificationW(
              "Oops!",
              "Pagamento Rejeitado. Por favor, tente novamente.",
              "error"
            );
            return;
          }
          var DadosCliente = {
            nome: this.nome_completo,
            dadosCompra: retornoPayment.data
          };
          sessionStorage.setItem("TipoCheck", "ca");
          sessionStorage.setItem("dadosCliente", JSON.stringify(DadosCliente));
          LRouter.push("/obrigado-cartao");
          API_NOTIFICATION.HideLoading();
        })
        .catch(error => {
          console.log("Erro ao efetuar o pagamento no PagSeguro", error);
        });
      //}
    },
    getAnoValidadeCartao() {
      const LAno = "20" + this.getValidadeCartao().ano;
      console.log("ANO Validad3e", LAno);
      return LAno;
    },
    async pay() {
      API_NOTIFICATION.ShowLoading();
      if (this.public_key !== null) {
        if (this.formaPagamento == "creditCard") {
          this.iniciaPagamentoBackEndCard();
        } else if (this.formaPagamento == "bolbradesco") {
          this.iniciaPagamentoBackEndBoleto();
        }
      } else {
      }
    },
    removeAcento(text) {
      text = text.toLowerCase();
      text = text.replace(new RegExp("[ÁÀÂÃ]", "gi"), "a");
      text = text.replace(new RegExp("[ÉÈÊ]", "gi"), "e");
      text = text.replace(new RegExp("[ÍÌÎ]", "gi"), "i");
      text = text.replace(new RegExp("[ÓÒÔÕ]", "gi"), "o");
      text = text.replace(new RegExp("[ÚÙÛ]", "gi"), "u");
      text = text.replace(new RegExp("[Ç]", "gi"), "c");
      return text;
    },
    getCripto(parametro_um, parametro_dois) {
      const hashids = new Hashids("", 0, "ABCDEFGHIJKLMNOPQRSTUVWXYZ");
      const produtHashed = hashids.encode(
        parametro_um.toString(),
        parametro_dois.toString()
      );
      // const numbers = hashids.decode(produtHashed);
      //console.log("ID Hashedid", produtHashed);
      // console.log("ID Deshashed", numbers);
      return produtHashed;
    },
    saveLead() {
      API_CLIENTES.SaveLead(this.email, this.nome_completo, this.telefone)
        .then(resLead => {
          console.log("Lead Salva com Suceso");
        })
        .catch(error => {
          console.log("Erro ao salvar lead", error);
        });
    }
  }
};
</script>
