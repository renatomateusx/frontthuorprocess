<style scoped>
.card-flat {
  margin-top: 80px !important;
}
.bg-dark {
  background-color: #23b7e5 !important;
}
.btn-outline-info {
  color: white;
  border-color: white;
}
.green {
  color: green !important;
}
.holder-icon {
  left: 0;
  position: absolute;
  top: 15px;
  font-size: 22px;
}
.remove {
  position: relative;
  top: 33px;
  cursor: pointer;
}
.center {
  text-align: center;
  display: block;
}
.QuatroCincopx {
  width: 45px !important;
}
.compare {
  color: red;
  font-weight: 700;
}
.priceReal {
  color: green;
  font-weight: 700;
}
.desconto {
  color: blue;
  font-weight: 700;
}
.btnIncrementDecrement {
  height: 21px;
}
.spanIncrementDecrement {
  top: -6px;
  margin: 0 auto;
  position: relative;
}
.cursorP {
  cursor: pointer !important;
}
.btnKeepBuyingFooter {
  color: #5d9cec;
  border-color: #5d9cec;
}
.iconBadge {
  background-color: #5d9cec;
  font-size: 15px;
  color: white;
}
.iconStep {
  border-radius: 50px;
  width: 50px;
  height: 50px;
  margin: 0 auto;
  display: block;
  color: white;
  background-color: #5d9cec;
  text-align: center;
  font-size: 34px;
  margin-top: 5px;
  line-height: normal;
}
.dadosPessoais {
  font-size: 20px;
  font-weight: 900;
  top: 1px;
  position: relative;
  color: #5d9cec;
  margin-left: 10px;
}
.resumoCompra {
  font-size: 16px;
  font-weight: 900;
  top: 1px;
  position: relative;
  color: #5d9cec;
  margin-left: 10px;
}
.comandoCollapse {
  margin-left: 5px;
  top: 2px;
  position: relative;
  color: dodgerblue;
  font-size: 17px;
}
.labelForm {
  margin: 0 0 0px;

  color: #4d4d4d;
  font-weight: 700;
}
.formGroup {
  margin-bottom: 0rem;
}
.card-default {
  border-color: #5d9cec;
}
.cardSide {
  padding: 0 5px;
  box-sizing: border-box;
  border-radius: 50px;
  display: inline !important;
}
.textInformation {
  line-height: 14px;
  color: #999 !important;
  padding: 0;
  padding-left: 30px;
  float: left;
  font-size: 11px;
  margin-bottom: 10px;
}
.minusmargintop {
  margin-top: -30px !important;
}
.box-title {
  position: relative;
  padding: 0 30px 0 35px;
  box-sizing: border-box;
}
.card-default {
  border-radius: 7px;
}
.btnContinue {
  height: 50px;
  font-size: 20px;
  border-radius: 10px;
}
.rounded {
  border-radius: 7px !important;
}
.disabledBox {
  cursor: default;
  pointer-events: none;
  -moz-opacity: 0.6;
  -khtml-opacity: 0.6;
  -webkit-opacity: 0.6;
  opacity: 0.6;
}
.paddingZero {
  padding: 0;
}
.localidade {
  top: 5px !important;
  font-size: 12px;
}
.dadosPessoaisNomeCompletoVModel {
  color: #4d4d4d !important;
  font-weight: 700 !important;
  font-size: 15px;
}
.paddingTopBottomZERO {
  padding-bottom: 0px !important;
  padding-top: 0px !important;
}
.enderecoEntregaHeader {
  font-size: 15px;
  font-weight: 700;
  color: grey;
}
.opcaoSelecionada {
  background-color: #dcdcdc;
  color: black;
  font-weight: bold;
  border-color: #dcdcdc;
  border: 2px solid #ccc;
}
.opcaoDeselecionada {
  font-weight: bold;
  color: gray;
  border-color: 2px solid #23b7e5;
}
.btnFrete {
  padding: 15px;
  margin: 10px;
  cursor: pointer !important;
  border-radius: 10px;
}
.btnFormaPagamentoSelecionada {
  padding: 5px;
  margin: 5px;
  cursor: pointer !important;
  border-radius: 10px;
}
.smallInforFormaPagamentoBoleto {
  padding: 5px;
  margin: 5px;
  cursor: pointer !important;
  border-radius: 10px;
  color: black;
  background-color: #dcdcdc;
  border: 2px solid #ccc;
}
.selecionadoInfo {
  margin-top: 10px;
  color: blueviolet;
  text-align: right !important;
  float: right !important;
}
.ValorTotalResumo {
  background-color: #f5f5f5;
  border-radius: 9px;
  height: 40px;
  color: white !important;
}
.textValorTotal {
  color: black;
  font-weight: 700;
  font-size: 1.2em;
  display: block;
  margin: 0 auto;
  text-align: center;
  top: 5px;
  float: left !important;
}
.textItems {
  color: black;
  margin-bottom: 5px !important;
}
.imgVariant {
  width: 50px;
  height: 50px;
  top: 7px;
  position: relative;
}
.textInfoFrete {
  text-align: left;
  font-size: 11px;
  white-space: pre-wrap;
}
.imageCard {
  width: 25px !important;
  height: 25px !important;
}
.valorTotalCollapse {
  font-weight: 700;
  color: #3fc583 !important;
  font-size: 15px;
}
.hidden {
  display: none !important;
}
.formCupom {
  margin: 0 auto !important;
}
@media only screen and (max-width: 992px) {
  #btnTop {
    display: block !important;
  }
  .valorTotalCollapse {
    font-weight: 700;
    color: #3fc583 !important;
    font-size: 11px !important;
    top: 3px !important;
    position: relative;
  }
  .resumoCompra {
    font-size: 13px !important;
  }
  .comandoCollapse {
    margin-left: 5px;
    top: 0px !important;
    position: relative;
    color: dodgerblue;
    font-size: 15px !important;
  }
  .formCupom {
    float: left !important;
  }
}
@media only screen and (max-width: 767px) {
  .QuatroCincopx {
    margin-left: 0px !important;
  }
  .remove {
    float: left;
    left: 60px;
    position: relative;
    top: -54px;
    cursor: pointer;
    font-size: 25px;
  }
  .valorTotalCollapse {
    font-weight: 700;
    color: #3fc583;
    font-size: 11px !important;
    top: 3px !important;
    position: relative;
  }
  .resumoCompra {
    font-size: 13px !important;
  }
  .comandoCollapse {
    margin-left: 5px;
    top: 0px !important;
    position: relative;
    color: dodgerblue;
    font-size: 15px !important;
  }
  .textoNaoObrigado {
    font-size: 10px !important;
  }
  .textItems {
    position: relative;
    top: 0px !important;
  }
  .formCupom {
    float: left !important;
  }
}
</style>
<template>
  <form
    @submit.prevent="validateBeforeSubmit('cupom')"
    data-vv-scope="cupom"
    class="formCupom pull-left float-left"
  >
    <div class="col-md-4 mt-0 mb-0 cardSide" v-show="MostraCupom == 1">
      <!-- START card-->
      <div class="form-group ml-0 float-left pull-left">
        <label class="col-form-label ml-2">Tem Cupom?</label>
        <div class="d-flex align-items-center">
          <input
            :class="{'form-control':true, 'is-invalid': errors.has('cupom.codigo_cupom')}"
            type="text"
            v-validate="'required'"
            name="codigo_cupom"
            placeholder="CUPOM30"
            v-model="cupom.codigo_cupom"
          />

          <button type="submit" class="ml-2 btn btn-primary">
            <span class="fa fa-arrow-right"></span>
          </button>
        </div>

        <div class="row">
          <p
            v-show="CupomAplicadoAuto == 1"
            class="alert alert-success p-1 mt-2 col-md-12"
          >Cupom Aplicado Automaticamente</p>
          <p v-for="cup in CupomCode" class="alert alert-info p-1">{{cup.code}}</p>
        </div>
      </div>

      <strong
        v-show="errors.has('cupom.codigo_cupom')"
        class="alert alert-danger p-1"
      >* Preencha o código do cupom!</strong>
      <!-- END card-->
    </div>
  </form>
</template>
<script>
import Vue from "vue";
import VeeValidate from "vee-validate";
import API_NOTIFICATION from "../../api/notification";
import API_PRODUTOS from "../../api/produtosAPI";
import API_LOJA from "../../api/lojaAPI";
import UTILIS_API from "../../api/utilisAPI";
import API_CHECKOUT from "../../api/checkoutAPI";
import pt from "vee-validate/dist/locale/pt_BR";
import API_LOGIN from "../../api/loginAPI";
import API_HEADERS from "../../api/configAxios";
import UTILIS from "../../utilis/utilis.js";
import LoadScript from "vue-plugin-load-script";
import router from "../../router.js";
import API_MKT from "../../api/marketingAPI";
import API_CHECKOUT_PS from "../../api/checkoutPSAPI";
import API_CUPOM from "../../api/cuponsAPI";
import moment from "moment";

Vue.use(LoadScript);

Vue.use(VeeValidate, {
  fieldsBagName: "formFields" // fix issue with b-table
});

export default {
  name: "cupom-card",
  created() {
    this.checkCupom();
  },
  props: {},
  computed: {},
  data() {
    return {
      DadosCheckout: {},
      produtosCart: [],
      MostraCupom: 1,
      CupomAplicadoAuto: 0,
      CupomAplicado: 0,
      CupomCode: [],
      ArrayDescontos: [],
      cupom: {
        codigo_cupom: ""
      }
    };
  },
  mounted() {
    this.$validator.localize("pt", {
      messages: {
        required: field => "* Este campo é obrigatório."
      },
      attributes: {}
    });
  },
  methods: {
    validateBeforeSubmit(scope) {
      this.$validator
        .validateAll(scope)
        .then(result => {
          if (result) {
            this.aplicarCupom();
            console.log("Cupom Submit");
            return;
          }
          this.errors.add({
            scope: scope,
            field: "codigo_cupom",
            msg: "Escolha um produto"
          });
          console.log("Correct them errors!");
        })
        .catch(error => {
          console.log("Erro ao tentar validar", error);
        });
    },
    async checkCupom() {
      if (sessionStorage.getItem("DadosLoja") != undefined) {
        this.dadosLoja = sessionStorage.getItem("DadosLoja");
        if (sessionStorage.getItem("cart") != null) {
          this.produtosCart = JSON.parse(sessionStorage.getItem("cart"));
        }
        if (this.produtosCart != null) {
          this.produtosCart.forEach((item, i) => {
            API_CUPOM.GetCupomByProductID(item.id_thuor).then(
              async resCupom => {
                const LCupom = resCupom.data;
                LCupom.forEach(async (objCupom, i) => {
                  const LPodeDesconto = await this.PodeDesconto(
                    objCupom,
                    item,
                    this.produtosCart.length
                  );
                  if (
                    LPodeDesconto &&
                    objCupom.aplicar_regra_automatica_carrinho == 1
                  ) {
                    const LValueDiscount = await this.CalculaDescontoCupom(
                      objCupom,
                      item
                    );
                    const LRetorno = await this.PushDesconto(
                      objCupom,
                      item,
                      LValueDiscount
                    );
                    if (LRetorno == 1) {
                      console.log("Aplicar Regra automática no carrinho");
                      var LNumeroUtilizados = objCupom.numero_utilizacao;
                      if (LNumeroUtilizados == null) LNumeroUtilizados = 0;
                      LNumeroUtilizados = parseInt(LNumeroUtilizados) + 1;
                      API_CUPOM.UpdateNumeroUtilizacao(
                        objCupom.id,
                        LNumeroUtilizados
                      )
                        .then(resUtilizados => {
                          this.$emit("recalcula");
                          this.CupomAplicadoAuto = 1;
                          this.CupomAplicado = 1;
                        })
                        .catch(error => {
                          console.log("Erro ao aplicar o coupom", error);
                        });
                    }
                  }
                });
              }
            );
          });
          this.arrayCupomCode();
        }
      } else {
        const LGetStore = await this.getDadosLoja();
        this.checkCupom();
      }
    },

    async getDadosLoja() {
      return new Promise((resolve, reject) => {
        //API_NOTIFICATION.ShowLoading();
        if (sessionStorage.getItem("DadosLoja") == undefined) {
          var store = JSON.parse(sessionStorage.getItem("DadosLoja")).url_loja;
          API_LOJA.GetDadosLoja(store)
            .then(res => {
              const LojaData = res.data;
              this.dadosLoja = LojaData;
              sessionStorage.setItem(
                "DadosLoja",
                JSON.stringify(this.dadosLoja)
              );
              resolve(1);
            })
            .catch(error => {
              console.log("Erro ao pegar dados da Loja", error);
              reject(error);
            });
        }
      });
    },
    getNomeLoja() {
      this.dadosLoja = JSON.parse(sessionStorage.getItem("DadosLoja")) || "";
      return this.dadosLoja.nome_loja;
    },

    getClassSelected(opcao) {
      return this.formaPagamento == opcao
        ? "opcaoSelecionada"
        : "opcaoDeselecionada";
    },
    collapseUpSell(id, idComando) {
      const element = document.querySelector(id);
      const elementComando = document.querySelector(idComando);
      if (element.classList.contains("show")) {
        element.classList.remove("show");
        elementComando.classList.remove("fa-arrow-up");
        elementComando.classList.add("fa-arrow-down");
      } else {
        element.classList.add("show");
        elementComando.classList.remove("fa-arrow-down");
        elementComando.classList.add("fa-arrow-up");
      }
    },
    removeAcento(text) {
      text = text.toLowerCase();
      text = text.replace(new RegExp("[ÁÀÂÃ]", "gi"), "a");
      text = text.replace(new RegExp("[ÉÈÊ]", "gi"), "e");
      text = text.replace(new RegExp("[ÍÌÎ]", "gi"), "i");
      text = text.replace(new RegExp("[ÓÒÔÕ]", "gi"), "o");
      text = text.replace(new RegExp("[ÚÙÛ]", "gi"), "u");
      text = text.replace(new RegExp("[Ç]", "gi"), "c");
      return text;
    },
    sleep(seconds) {
      return new Promise(r => setTimeout(r, seconds));
    },
    aplicarCupom() {
      API_NOTIFICATION.ShowLoading();
      var self = this;
      API_CUPOM.GetCupomByCODE(this.cupom)
        .then(async resCupom => {
          const LCupom = resCupom.data;
          if (sessionStorage.getItem("cart") != null) {
            self.produtosCart = JSON.parse(sessionStorage.getItem("cart"));
          }

          if (this.produtosCart != null) {
            this.produtosCart.forEach(async (item, i) => {
              const LPodeDesconto = await this.PodeDesconto(
                LCupom,
                item,
                self.produtosCart.length
              );
              if (LPodeDesconto) {
                const LValueDiscount = await this.CalculaDescontoCupom(
                  LCupom,
                  item
                );
                const LRetorno = await this.PushDesconto(
                  LCupom,
                  item,
                  LValueDiscount
                );
                if (LRetorno == 1) {
                  var LNumeroUtilizados = LCupom.numero_utilizacao;
                  LNumeroUtilizados = parseInt(LNumeroUtilizados) + 1;
                  API_CUPOM.UpdateNumeroUtilizacao(LCupom.id, LNumeroUtilizados)
                    .then(resUtilizados => {
                      this.$emit("recalcula");
                      this.CupomAplicado = 1;
                      API_NOTIFICATION.HideLoading();
                    })
                    .catch(error => {
                      console.log("Erro ao aplicar o coupom", error);
                      API_NOTIFICATION.HideLoading();
                    });
                }
              }else{
                API_NOTIFICATION.HideLoading();
              }
            });
          }
          this.arrayCupomCode();
        })
        .catch(error => {
          console.log("Erro ao pegar o cupom", error);
          API_NOTIFICATION.HideLoading();
        });
    },
    PodeDesconto(JSONCupom, item, quantidade_itens_carrinho) {
      return new Promise((resolve, reject) => {
        var LRetorno = true;
        /* total_disponivel, valor_minimo_compra, data_inicio, data_fim, exige_quantidade_minima, quantidade_minima, 
      tipo_desconto, valor_desconto, aplicar_regra_automatica_carrinho, permite_acumular, uso_unico, 
      envia_automaticamente_carrinho_abandonado, cupom_primeira_compra, aplicar_regra_produtos_especificos, aplicar_regra_colecao, 
      aplicar_regra_marca, aplicar_regra_categoria, aplicar_regra_forma_pagamento, exceptuar_regra_produtos_especificos, 
      exceptuar_regra_colecao, exceptuar_regra_marca, exceptuar_regra_categoria, exceptuar_regra_forma_pagamento, frete_gratis */

        /* id_thuor: "156"
          id_usuario: "1"
          quantity: 1         
          variant_id: 33311522848827         
          variant_price: "142.00"
          variant_price_ancora: "189.00"         
          */

        try {
          var LFindProd = "";
          if (
            JSONCupom.aplicar_regra_produtos_especificos != undefined &&
            JSONCupom.aplicar_regra_produtos_especificos.length > 0
          ) {
            LFindProd = JSONCupom.aplicar_regra_produtos_especificos.find(
              x => x.id_thuor == item.id_thuor
            );
          }

          if (moment().format() < moment(JSONCupom.data_inicio).format()) {
            LRetorno = false;
            console.log(1);
          } else if (moment().format() > moment(JSONCupom.data_fim).format()) {
            LRetorno = false;
            console.log(2);
          } else if (
            JSONCupom.numero_utilizacao != null &&
            parseInt(JSONCupom.numero_utilizacao) > 0 &&
            parseInt(JSONCupom.total_disponivel) ==
              parseInt(JSONCupom.numero_utilizacao)
          ) {
            LRetorno = false;
            console.log(3);
          } else if (
            parseFloat(item.variant_price) <
            parseFloat(JSONCupom.valor_minimo_compra)
          ) {
            LRetorno = false;
            console.log(
              parseFloat(JSONCupom.valor_minimo_compra),
              parseFloat(item.variant_price)
            );
            console.log(4);
          } else if (
            JSONCupom.exige_quantidade_minima == 1 &&
            parseInt(JSONCupom.quantidade_minima) <
              parseInt(quantidade_itens_carrinho)
          ) {
            LRetorno = false;
            console.log(5);
          } else if (
            JSONCupom.permite_acumular == 0 &&
            this.ArrayDescontos.length > 0
          ) {
            LRetorno = false;
            console.log(6);
          } else if (
            JSONCupom.aplicar_regra_produtos_especificos != undefined &&
            JSONCupom.aplicar_regra_produtos_especificos != null &&
            LFindProd == undefined
          ) {
            LRetorno = false;
            console.log(7);
          }
          if (LRetorno) {
            this.ArrayDescontos.push({ cupom: JSONCupom.code });
          }
          //console.log("ArrayDesc", this.ArrayDescontos, LRetorno);
          resolve(LRetorno);
        } catch (error) {
          console.log("Erro ao tratar o pode desconto", error);
          reject(error);
        }
      });
    },
    CalculaDescontoCupom(JSONCupom, item) {
      return new Promise((resolve, reject) => {
        var LRetornoDesconto = 0;
        try {
          if (JSONCupom.tipo_desconto == 1) {
            const LDesconto =
              (parseFloat(JSONCupom.valor_desconto) / 100) *
              parseFloat(item.variant_price);
            LRetornoDesconto = parseFloat(LDesconto);
          }
          if (JSONCupom.tipo_desconto == 2) {
            const LDesconto =
              parseFloat(item.variant_price) -
              parseFloat(JSONCupom.valor_desconto);
            LRetornoDesconto = parseFloat(LDesconto);
          }
          resolve(LRetornoDesconto);
        } catch (error) {
          console.log("Erro ao calcular o DescontoCupom", error);
          reject(error);
        }
      });
    },
    PushDesconto(JSONCupom, item, valorDesconto) {
      return new Promise((resolve, reject) => {
        try {
          var LRetorno = 0;
          var LUL = [];
          var LValor = 0;
          if (sessionStorage.getItem("ul") != null) {
            LUL = JSON.parse(atob(sessionStorage.getItem("ul")));
          }
          console.log(LUL);
          const LFindCode = LUL.find(x => x.code == JSONCupom.code);
          if (LFindCode == undefined) {
            LUL.push({
              code: JSONCupom.code,
              valor: valorDesconto,
              auto: JSONCupom.aplicar_regra_automatica_carrinho
            });
            LUL.forEach((objLUL, i) => {
              LValor = LValor + parseFloat(objLUL.valor);
            });
            LUL = JSON.stringify(LUL);
            LUL = btoa(LUL);
            sessionStorage.setItem("ul", LUL);
            sessionStorage.setItem("vld", parseFloat(LValor));
            LRetorno = 1;
          } else {
            LRetorno = 0;
          }
          this.arrayCupomCode();
          resolve(LRetorno);
        } catch (error) {
          console.log("Erro ao fazer o push desconto", error);
          reject(error);
        }
      });
    },
    arrayCupomCode() {
      if (sessionStorage.getItem("ul") != null) {
        this.CupomCode = JSON.parse(atob(sessionStorage.getItem("ul")));
        var LAuto = this.CupomCode.find(x => x.auto == 1);
        if (this.CupomCode.length > 0 && LAuto != undefined) {
          this.CupomAplicadoAuto = 1;
        }
      }
      console.log(this.CupomCode);
      return this.CupomCode;
    }
  }
};
</script>
