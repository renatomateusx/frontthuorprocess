<style scoped>
.card-flat {
  margin-top: 80px !important;
}
.bg-dark {
  background-color: #23b7e5 !important;
}
.btn-outline-info {
  color: white;
  border-color: white;
}
.green {
  color: green !important;
}
.holder-icon {
  left: 0;
  position: absolute;
  top: 15px;
  font-size: 22px;
}
.remove {
  position: relative;
  top: 33px;
  cursor: pointer;
}
.center {
  text-align: center;
  display: block;
}
.QuatroCincopx {
  width: 45px !important;
}
.compare {
  color: red;
  font-weight: 700;
}
.priceReal {
  color: green;
  font-weight: 700;
}
.desconto {
  color: blue;
  font-weight: 700;
}
.btnIncrementDecrement {
  height: 21px;
}
.spanIncrementDecrement {
  top: -6px;
  margin: 0 auto;
  position: relative;
}
.cursorP {
  cursor: pointer !important;
}
.btnKeepBuyingFooter {
  color: #5d9cec;
  border-color: #5d9cec;
}
.iconBadge {
  background-color: #5d9cec;
  font-size: 15px;
  color: white;
}
.iconStep {
  border-radius: 50px;
  width: 50px;
  height: 50px;
  margin: 0 auto;
  display: block;
  color: white;
  background-color: #5d9cec;
  text-align: center;
  font-size: 34px;
  margin-top: 5px;
  line-height: normal;
}
.dadosPessoais {
  font-size: 20px;
  font-weight: 900;
  top: 1px;
  position: relative;
  color: #5d9cec;
  margin-left: 10px;
}
.resumoCompra {
  font-size: 16px;
  font-weight: 900;
  top: 1px;
  position: relative;
  color: #5d9cec;
  margin-left: 10px;
}
.comandoCollapse {
  margin-left: 5px;
  top: 2px;
  position: relative;
  color: dodgerblue;
  font-size: 17px;
}
.labelForm {
  margin: 0 0 0px;

  color: #4d4d4d;
  font-weight: 700;
}
.formGroup {
  margin-bottom: 0rem;
}
.card-default {
  border-color: #5d9cec;
}
.cardSide {
  padding: 0 5px;
  box-sizing: border-box;
  border-radius: 50px;
  display: inline !important;
}
.textInformation {
  line-height: 14px;
  color: #999 !important;
  padding: 0;
  padding-left: 30px;
  float: left;
  font-size: 11px;
  margin-bottom: 10px;
}
.minusmargintop {
  margin-top: -30px !important;
}
.box-title {
  position: relative;
  padding: 0 30px 0 35px;
  box-sizing: border-box;
}
.card-default {
  border-radius: 7px;
}
.btnContinue {
  height: 50px;
  font-size: 20px;
  border-radius: 10px;
}
.rounded {
  border-radius: 7px !important;
}
.disabledBox {
  cursor: default;
  pointer-events: none;
  -moz-opacity: 0.6;
  -khtml-opacity: 0.6;
  -webkit-opacity: 0.6;
  opacity: 0.6;
}
.paddingZero {
  padding: 0;
}
.localidade {
  top: 5px !important;
  font-size: 12px;
}
.dadosPessoaisNomeCompletoVModel {
  color: #4d4d4d !important;
  font-weight: 700 !important;
  font-size: 15px;
}
.paddingTopBottomZERO {
  padding-bottom: 0px !important;
  padding-top: 0px !important;
}
.enderecoEntregaHeader {
  font-size: 15px;
  font-weight: 700;
  color: grey;
}
.opcaoSelecionada {
  background-color: #dcdcdc;
  color: black;
  font-weight: bold;
  border-color: #dcdcdc;
  border: 2px solid #ccc;
}
.opcaoDeselecionada {
  font-weight: bold;
  color: gray;
  border-color: 2px solid #23b7e5;
}
.btnFrete {
  padding: 15px;
  margin: 10px;
  cursor: pointer !important;
  border-radius: 10px;
}
.btnFormaPagamentoSelecionada {
  padding: 5px;
  margin: 5px;
  cursor: pointer !important;
  border-radius: 10px;
}
.smallInforFormaPagamentoBoleto {
  padding: 5px;
  margin: 5px;
  cursor: pointer !important;
  border-radius: 10px;
  color: black;
  background-color: #dcdcdc;
  border: 2px solid #ccc;
}
.selecionadoInfo {
  margin-top: 10px;
  color: blueviolet;
  text-align: right !important;
  float: right !important;
}
.ValorTotalResumo {
  background-color: #f5f5f5;
  border-radius: 9px;
  height: 40px;
  color: white !important;
}
.textValorTotal {
  color: black;
  font-weight: 700;
  font-size: 1.2em;
  display: block;
  margin: 0 auto;
  text-align: center;
  top: 5px;
  float: left !important;
}
.textItems {
  color: black;
  margin-bottom: 5px !important;
}
.imgVariant {
  width: 50px;
  height: 50px;
  top: 7px;
  position: relative;
}
.textInfoFrete {
  text-align: left;
  font-size: 11px;
  white-space: pre-wrap;
}
.imageCard {
  width: 25px !important;
  height: 25px !important;
}
.valorTotalCollapse {
  font-weight: 700;
  color: #3fc583 !important;
  font-size: 15px;
}
.hidden {
  display: none !important;
}
@media only screen and (max-width: 992px) {
  #btnTop {
    display: block !important;
  }
  .valorTotalCollapse {
    font-weight: 700;
    color: #3fc583 !important;
    font-size: 11px !important;
    top: 3px !important;
    position: relative;
  }
  .resumoCompra {
    font-size: 13px !important;
  }
  .comandoCollapse {
    margin-left: 5px;
    top: 0px !important;
    position: relative;
    color: dodgerblue;
    font-size: 15px !important;
  }
}
@media only screen and (max-width: 767px) {
  .QuatroCincopx {
    margin-left: 0px !important;
  }
  .remove {
    float: left;
    left: 60px;
    position: relative;
    top: -54px;
    cursor: pointer;
    font-size: 25px;
  }
  .valorTotalCollapse {
    font-weight: 700;
    color: #3fc583;
    font-size: 11px !important;
    top: 3px !important;
    position: relative;
  }
  .resumoCompra {
    font-size: 13px !important;
  }
  .comandoCollapse {
    margin-left: 5px;
    top: 0px !important;
    position: relative;
    color: dodgerblue;
    font-size: 15px !important;
  }
  .textoNaoObrigado {
    font-size: 10px !important;
  }
  .textItems {
    position: relative;
    top: 0px !important;
  }
}
</style>
<template>
  <!-- <div class="row col-lg-4 col-lg-offset-2" style=" margin: 0 auto; display:block"> -->
  <!-- START STEP 4-->
  <!-- 1= "No Checkout";
        2= "Na Finalização";
  3= "E-mail e WhatsApp";-->
  <div class="col-md-4 mt-0 mb-0 cardSide" v-show="UpSellNoCheckout == noCheckout">
    <!-- START card-->
    <div class="card card-default mb-0" v-show="UpSellNoCheckout == noCheckout">
      <div class="card-header rounded">
        <a
          style="cursor:pointer!important;"
          aria-expanded="false"
          v-on:click="collapseUpSell('#collaUpSell', '#comandoUpSell')"
        >
          <span
            id="DcollaUpSell"
            class="resumoCompra pull-left float-left ml-0"
            role="button"
          >Achamos que você pode gostar...</span>
          <small style="cursor:pointer!important;" class="ml-2 text-left textItems"></small>
          <small class="valorTotalCollapse pull-right float-right">
            <span
              class="fa fa-arrow-up comandoCollapse pull-right float-right"
              id="comandoUpSell"
              role="button"
            >
              <span class="textNaoObrigado ml-1">Não quero</span>
            </span>
          </small>
        </a>

        <div class="col-lg-12 collapse show" id="collaUpSell" data-parent="#collapseParent">
          <div class="row">
            <div class="col-md-12">
              <div class="items">
                <div class="product">
                  <div class="row col-md-12">
                    <div class="mt-2 w-100">
                      <img class="rounded img-fluid float-left imgVariant" :src="variant_img" />
                      <div class="product-name">
                        <div class="product-name">
                          <a class="ml-2 w-100 mt-2" href="#">{{ title }}</a>
                          <div class="product-info">
                            <div>
                              <span class="value ml-2">
                                {{
                                variant_title
                                }}
                              </span>
                            </div>
                          </div>
                          <div class="product-info">
                            <div>
                              <span class="value ml-2">
                                <small>
                                  {{ quantity }} Unidade(s) -
                                  <b>R$ {{ formatPrice(variant_price) }}</b>
                                </small>
                              </span>
                            </div>
                          </div>
                          <div class="product-info row col-md-4" id="productOptions"></div>
                          <button
                            v-show="
                              VarianteIDUpSellSelected > 0 &&
                                UpSellNoCheckout == 1
                            "
                            v-on:click="adicionarProdutoUpSell()"
                            class="mt-2 btn btn-primary btn-lg btn-block float-left pull-left btnContinue"
                          >Adicionar</button>
                          <button
                            v-show="
                              VarianteIDUpSellSelected > 0 &&
                                UpSellNoCheckout == 2
                            "
                            v-on:click="comprarComUmClique()"
                            class="mt-2 btn btn-primary btn-lg btn-block float-left pull-left btnContinue"
                          >Comprar com um CLIQUE</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <hr />
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="card-body minusmargintop"></div>
    </div>
    <!-- END card-->
  </div>
  <!-- END STEP 4-->
  <!-- </div> -->
</template>
<script>
import Vue from "vue";
import VeeValidate from "vee-validate";
import Multiselect from "vue-multiselect";
import money from "v-money";
import API_NOTIFICATION from "../../api/notification";
import API_PRODUTOS from "../../api/produtosAPI";
import API_LOJA from "../../api/lojaAPI";
import UTILIS_API from "../../api/utilisAPI";
import API_CHECKOUT from "../../api/checkoutAPI";

import API_LOGIN from "../../api/loginAPI";
import API_HEADERS from "../../api/configAxios";
import UTILIS from "../../utilis/utilis.js";
import LoadScript from "vue-plugin-load-script";
import router from "../../router.js";
import API_MKT from "../../api/marketingAPI";
import API_CHECKOUT_PS from "../../api/checkoutPSAPI";

Vue.use(LoadScript);

Vue.use(VeeValidate, {
  fieldsBagName: "formFields" // fix issue with b-table
});

Vue.component("multiselect", Multiselect);
Vue.use(money, { precision: 2 });

Vue.mixin({
  data: function() {
    return {};
  }
});

export default {
  name: "up-sell-card",
  created() {
    //API_NOTIFICATION.ShowLoading();
    this.checkUpSell();
    //document.addEventListener('beforeunload', this.clearSessionStorage);
  },
  props: {
    noCheckout: { type: Number, required: true }
  },
  computed: {},
  data() {
    return {
      price: 123.45,
      money: {
        decimal: ",",
        thousands: ".",
        prefix: " ",
        suffix: "",
        precision: 2,
        masked: false /* doesn't work with directive */
      },
      DadosCheckout: {},
      produtosCart: [],
      produtosUpSell: [],
      variant_img: "",
      title: "",
      variant_title: "",
      variant_price: "0,00",
      quantity: 0,
      LImages: [],
      LVariantes: [],
      LOptions: [],
      VarianteIDProdutoJSONUpSellSelected: 0,
      VarianteIDUpSellSelected: 0,
      VarianteImageUpSellSelected: "",
      VarianteSKUUpSellSelected: "",
      VariantePriceUpSellSelected: 0,
      VarianteTitleUPSellSelected: "",
      UpSellNoCheckout: 0,
      LUp: 0,
      reference_id: ""
    };
  },
  mounted() {},
  methods: {
    formatPrice(value) {
      let val = (value / 1).toFixed(2).replace(".", ",");
      return val.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    },
    validateBeforeSubmit(scope) {
      this.$validator.validateAll(scope).then(result => {
        if (result) {
          API_NOTIFICATION.ShowLoading();
          // simulate AJAX

          return;
        }
        console.log("Correct them errors!");
      });
    },
    async checkUpSell() {
      if (sessionStorage.getItem("DadosLoja") != undefined) {
        this.dadosLoja = sessionStorage.getItem("DadosLoja");
        if (sessionStorage.getItem("cart") != null) {
          this.produtosCart = JSON.parse(sessionStorage.getItem("cart"));
        }
        if (this.produtosCart != null) {
          this.LUp = sessionStorage.getItem("up", "1");
          //console.log(this.LUp);
          if (this.LUp == 1) {
            this.UpSellNoCheckout = -1;
            return;
          }
          this.produtosCart.forEach((item, i) => {
            API_MKT.GetUpSellsByProductID(item.id_thuor).then(
              resProductUpSell => {
                //console.log(resProductUpSell.data);
                this.UpSellNoCheckout =
                  resProductUpSell.data.tipo_checkout || 0;
                //console.log(this.UpSellNoCheckout);
                const ProdUS = resProductUpSell.data.id_produto_to;
                API_PRODUTOS.GetProdutoIDThuor(ProdUS)
                  .then(resProdTo => {
                    const LProdutoEncontrado = resProdTo.data;
                    if (LProdutoEncontrado.id_produto_json != undefined) {
                      this.VarianteIDProdutoJSONUpSellSelected =
                        LProdutoEncontrado.id_produto_json;
                      this.LVariantes = JSON.parse(
                        LProdutoEncontrado.json_dados_produto
                      ).variants;
                      this.LImages = JSON.parse(
                        LProdutoEncontrado.json_dados_produto
                      ).images;
                      this.LOptions = JSON.parse(
                        LProdutoEncontrado.json_dados_produto
                      ).options;
                      this.title = LProdutoEncontrado.titulo_produto;
                      if (
                        this.LVariantes != undefined &&
                        this.LVariantes.length > 0
                      ) {
                        this.quantity = item.quantidade || 1;
                        const lpreco =
                          parseFloat(this.LVariantes[0].price) * this.quantity;
                        this.variant_price = lpreco;
                        this.variant_img = this.LImages.find(
                          x => x.id == this.LVariantes[0].image_id
                        ).src;
                      }
                      if (this.LVariantes && this.LVariantes.length > 0) {
                        var select = document.createElement("select");
                        select.name = "Opcao";
                        select.id = "Opcao";
                        select.setAttribute(
                          "class",
                          "form-control col-md-12 mt-2"
                        );
                        var self = this;
                        select.onchange = function() {
                          self.toggleSelect(select);
                        };
                        document.getElementById("productOptions").innerHTML =
                          "";
                        document
                          .getElementById("productOptions")
                          .append(select);
                        var option = document.createElement("option");
                        option.value = 0;
                        option.text = "Selecione";
                        select.appendChild(option);
                        this.LVariantes.forEach((obj, i) => {
                          var option = document.createElement("option");
                          option.value = obj.id;
                          option.text = obj.title;
                          select.appendChild(option);
                        });
                      }
                      this.variant_title = "";
                    }
                  })
                  .catch(errorProd => {
                    console.log("Erro ao pegar o produto", errorProd);
                  });

                if (this.UpSellNoCheckout == 2) {
                  sessionStorage.setItem("UpSell", "2");
                }
              }
            );
          });
        }
      }
    },

    async getDadosLoja() {
      //API_NOTIFICATION.ShowLoading();
      if (sessionStorage.getItem("DadosLoja") == undefined) {
        var store = JSON.parse(sessionStorage.getItem("DadosLoja")).url_loja;
        API_LOJA.GetDadosLoja(store)
          .then(res => {
            const LojaData = res.data;
            this.dadosLoja = LojaData;
            UTILIS_API.SetDadosLojaSession(this.dadosLoja);
          })
          .catch(error => {
            console.log("Erro ao pegar dados da Loja", error);
          });
      }
    },
    getNomeLoja() {
      this.dadosLoja = JSON.parse(sessionStorage.getItem("DadosLoja")) || "";
      return this.dadosLoja.nome_loja;
    },

    getClassSelected(opcao) {
      return this.formaPagamento == opcao
        ? "opcaoSelecionada"
        : "opcaoDeselecionada";
    },
    collapseUpSell(id, idComando) {
      const element = document.querySelector(id);
      const elementComando = document.querySelector(idComando);
      if (element.classList.contains("show")) {
        element.classList.remove("show");
        elementComando.classList.remove("fa-arrow-up");
        elementComando.classList.add("fa-arrow-down");
      } else {
        element.classList.add("show");
        elementComando.classList.remove("fa-arrow-down");
        elementComando.classList.add("fa-arrow-up");
      }
    },
    removeAcento(text) {
      text = text.toLowerCase();
      text = text.replace(new RegExp("[ÁÀÂÃ]", "gi"), "a");
      text = text.replace(new RegExp("[ÉÈÊ]", "gi"), "e");
      text = text.replace(new RegExp("[ÍÌÎ]", "gi"), "i");
      text = text.replace(new RegExp("[ÓÒÔÕ]", "gi"), "o");
      text = text.replace(new RegExp("[ÚÙÛ]", "gi"), "u");
      text = text.replace(new RegExp("[Ç]", "gi"), "c");
      return text;
    },
    toggleSelect(componente) {
      const ID = componente.id;
      var Selected = componente.options[componente.selectedIndex].value;
      if (Selected == 0) {
        this.VarianteIDUpSellSelected = 0;
        return;
      }
      const LImageID = this.LVariantes.find(x => x.id == Selected).image_id;
      this.variant_img = this.LImages.find(x => x.id == LImageID).src;
      this.LVariantes.find(x => x.id == Selected).selected = Selected;
      const LSKU = this.LVariantes.find(x => x.id == Selected).sku;
      this.LVariantes.find(x => x.id == Selected).SkuSelected = LSKU;
      this.variant_title = this.LVariantes.find(x => x.id == Selected).title;
      const LPrice = this.LVariantes.find(x => x.id == Selected).price;
      //const LVarianteIDSelected = this.LVariantes.find(x = x.id ==)
      this.VarianteIDUpSellSelected = Selected;
      this.VarianteImageUpSellSelected = this.variant_img;
      this.VarianteSKUUpSellSelected = LSKU;
      this.VariantePriceUpSellSelected = parseFloat(LPrice);
      this.VarianteTitleUPSellSelected = this.variant_title;
    },
    async adicionarProdutoUpSell() {
      var lpro = await this.pushProducts(
        this.VarianteIDProdutoJSONUpSellSelected,
        this.quantity,
        this.VarianteIDUpSellSelected
      );
      /*ADICIONADO O TRECHO ABAIXO PARA GERENCIAR A QUANTIDADE NO CART, AO INVÉS DE FICAR AIDICONANDO VÁRIOS ITEMS */
      /* SE FICAR DANDO PROBLEMA COMENTE E O CÓDIGO ATÉ ONDE TEM 'ATÉ AQUI PARA GERENCIAR'  E DESCOMENTE A LINHA BAIXO*/
      //this.produtosCart.push(lpro);
      var LExists = this.produtosCart.find(
        x => x.variant_id == this.VarianteIDUpSellSelected
      );
      if (LExists == undefined) {
        this.produtosCart.push(lpro);
      } else {
        var LQuantidade = this.produtosCart.find(
          x => x.variant_id == this.VarianteIDUpSellSelected
        ).quantity;
        LQuantidade = LQuantidade + lpro.quantity;
        this.produtosCart.find(
          x => x.variant_id == this.VarianteIDUpSellSelected
        ).quantity = LQuantidade;
      }
      /*'ATÉ AQUI PARA GERENCIAR' */
      sessionStorage.setItem("cart", JSON.stringify(this.produtosCart));
      this.$emit("recalcula");
      //this.UpSellNoCheckout = 0;
    },
    async pushProducts(product, quantity, variante_id) {
      return new Promise(async (resolve, reject) => {
        try {
          API_PRODUTOS.GetProdutoByIDImported(product, quantity, variante_id)
            .then(retorno => {
              this.getDadosLoja(retorno.data.id_usuario);
              resolve(retorno.data);
            })
            .catch(error => {
              console.log("Error ao pegar o Produto no Thuor.com", error);
            });
        } catch (error) {
          console.log("Erro ao pegar os dados do produto na API", error);
        }
      });
    },
    clearSessionStorage() {
      sessionStorage.clear();
    },
    async FCheckoutMP(LDecripto) {
      const self = this;
      const plugin = document.createElement("script");
      plugin.onload = async () => {
        //await self.sleep(1000);
        if (window.Mercadopago != undefined) {
          window.Mercadopago.setPublishableKey(
            this.DadosCheckout.chave_publica
          );
          await this.sleep(1000);
          const LTipoCompra = sessionStorage.getItem("TipoCheck");
          var LRouter = router;
          LDecripto.paymentData.transaction_amount = this.formatPrice(
            this.VariantePriceUpSellSelected
          );

          let LCripto = JSON.stringify(LDecripto);
          LCripto = btoa(LCripto);
          sessionStorage.setItem("LCrypto", LCripto);
          if (LTipoCompra == "bo") {
            API_CHECKOUT.DoPayBackEndTicket(LCripto)
              .then(async retornoPay => {
                //console.log("Enviado para o backend", retornoPay.data);
                let LocalDecrypto = atob(LCripto);
                LocalDecrypto = JSON.parse(LocalDecrypto);
                var DadosCliente = {
                  nome: LocalDecrypto.dadosComprador.nome_completo,
                  dadosCompra: retornoPay.data
                };
                UTILIS_API.SetDadosClientesSession(DadosCliente);

                window.Mercadopago.clearSession();
                sessionStorage.setItem("up", "1");
                this.UpSellNoCheckout = -1;
                this.$emit("update");
                await this.sleep(1000);
                API_NOTIFICATION.HideLoading();
                LRouter.push("/obrigado-boleto");
              })
              .catch(error => {
                console.log("Erro ao tentar efetuar o pagamento", error);
                API_NOTIFICATION.showNotification(
                  "Por favor, tente novamente ",
                  "error"
                );
              });
          }
          if (LTipoCompra == "ca") {
            var FormToken = await UTILIS_API.CREATE_FORM_MP(
              this.getNomeLoja(),
              this.formatPrice(LDecripto.paymentData.transaction_amount),
              LDecripto.dadosComprador.numero_cartao.trim().replace(/ /g, ""),
              LDecripto.dadosComprador.nome_titular,
              LDecripto.dadosComprador.validade.split("/")[0],
              "20" + LDecripto.dadosComprador.validade.split("/")[1],
              LDecripto.dadosComprador.codigo_seguranca,
              LDecripto.paymentData.installments,
              LDecripto.dadosComprador.cpf_titular.replace(/[.-]/g, ""),
              LDecripto.paymentData.payer.email,
              LDecripto.paymentData.payment_method_id
            );
            //console.log(FormToken);
            window.Mercadopago.createToken(FormToken, (status, response) => {
              //console.log("Response", response);
              //console.log(1, LocalDecrypto.paymentData);
              LDecripto.paymentData.token = response.id;
              //console.log(2, LocalDecrypto.paymentData);
              var LAuxCripto = LDecripto;

              let LCripto = JSON.stringify(LDecripto);
              LCripto = btoa(LCripto);
              API_CHECKOUT.DoPayBackEnd(LCripto)
                .then(async retornoPay => {
                  var DadosCliente = {
                    nome: LAuxCripto.dadosComprador.nome_completo,
                    dadosCompra: retornoPay.data
                  };
                  UTILIS_API.SetDadosClientesSession(DadosCliente);
                  sessionStorage.setItem("up", "1");
                  this.UpSellNoCheckout = -1;
                  this.$emit("update");
                  await this.sleep(1000);
                  window.Mercadopago.clearSession();
                  API_NOTIFICATION.HideLoading();
                  return true;
                  LRouter.push("/obrigado-cartao");
                })
                .catch(error => {
                  console.log("Erro ao tentar efetuar o pagamento", error);
                  API_NOTIFICATION.showNotification(
                    "Por favor, tente novamente ",
                    "error"
                  );
                });
            });
          }
        } else {
          await self.sleep(1000);
          this.FCheckoutMP();
        }
      };
      plugin.setAttribute(
        "src",
        "https://secure.mlstatic.com/sdk/javascript/v1/mercadopago.js"
      );
      plugin.async = true;
      document.head.appendChild(plugin);
    },
    async FCheckoutPS(LDecripto) {
      const pluginPS = document.createElement("script");
      pluginPS.onload = function() {
        var LRouter = router;

        this.DadosCheckout = JSON.parse(
          sessionStorage.getItem("DadosCheckout")
        );
        this.componenteMPLoaded = 1;
        const LTipoCompra = sessionStorage.getItem("TipoCheck");
        LDecripto.paymentData.amount.value = this.formatPrice(
          this.VariantePriceUpSellSelected
        );
        if (LTipoCompra == "ca") {
          API_CHECKOUT_PS.GetPublicKey("card", this.DadosCheckout.token_acesso)
            .then(async resPublicKey => {
              var card = await PagSeguro.encryptCard({
                publicKey: resPublicKey.data,
                holder: LDecripto.dadosComprador.nome_titular,
                number: LDecripto.dadosComprador.numero_cartao.replace(
                  / /g,
                  ""
                ),
                expMonth: LDecripto.dadosComprador.validade.split("/")[0],
                expYear: "20" + LDecripto.dadosComprador.validade.split("/")[1],
                securityCode: LDecripto.dadosComprador.codigo_seguranca
              });
              if (card.errors.length > 0) {
                if (
                  card.errors[0] != undefined &&
                  card.errors[0].code == "INVALID_NUMBER"
                ) {
                  API_NOTIFICATION.showNotificationW(
                    "Oops!",
                    "Número de Cartão Inválido",
                    "error"
                  );
                }
                return;
              }
              //console.log(1, LDecripto.paymentData.payment_method.card.encrypted);
              LDecripto.paymentData.payment_method.card.encrypted =
                card.encryptedCard;
              //console.log(2, LDecripto.paymentData.payment_method.card.encrypted);
              let LCripto = JSON.stringify(LDecripto);
              LCripto = btoa(LCripto);
              sessionStorage.setItem("LCrypto", LCripto);
              API_CHECKOUT_PS.DoPayPagSeguro(LCripto)
                .then(async retornoPaymentPagSeguro => {
                  var DadosCliente = {
                    nome: this.nome_completo,
                    dadosCompra: retornoPaymentPagSeguro.data
                  };
                  UTILIS_API.SetDadosClientesSession(DadosCliente);
                  sessionStorage.setItem("up", "1");
                  this.UpSellNoCheckout = -1;
                  this.$emit("update");
                  await this.sleep(1000);
                  API_NOTIFICATION.HideLoading();
                  LRouter.push("/obrigado-cartao");
                })
                .catch(error => {
                  console.log(
                    "Erro ao efetuar o pagamento no PagSeguro",
                    error
                  );
                  API_NOTIFICATION.showNotification(
                    "Por favor, tente novamente ",
                    "error"
                  );
                });
            })
            .catch(error => {
              console.log("Erro", error);
            });
        }
        if (LTipoCompra == "bo") {
          let LCripto = JSON.stringify(LDecripto);
          LCripto = btoa(LCripto);
          sessionStorage.setItem("LCrypto", LCripto);
          API_CHECKOUT_PS.DoPayPagSeguro(LCripto)
            .then(async retornoPaymentPagSeguro => {
              var DadosCliente = {
                nome: this.nome_completo,
                dadosCompra: retornoPaymentPagSeguro.data
              };
              UTILIS_API.SetDadosClientesSession(DadosCliente);
              sessionStorage.setItem("up", "1");
              this.UpSellNoCheckout = -1;
              this.$emit("update");
              await this.sleep(1000);
              API_NOTIFICATION.HideLoading();
              LRouter.push("/obrigado-cartao");
            })
            .catch(error => {
              console.log("Erro ao efetuar o pagamento no PagSeguro", error);
              API_NOTIFICATION.showNotification(
                "Por favor, tente novamente ",
                "error"
              );
            });
          LRouter.push("/obrigado-boleto");
        }
      };
      pluginPS.setAttribute(
        "src",
        "https://assets.pagseguro.com.br/checkout-sdk-js/rc/dist/browser/pagseguro.min.js"
      );
      pluginPS.async = true;
      document.head.appendChild(pluginPS);
      await this.sleep(1000);
      if (PagSeguro !== undefined) {
        return true;
      } else {
        await this.sleep(1000);
        this.FCheckoutPS();
      }
    },
    async FCheckoutPayU(LDecripto) {
      var self = this;
      const SessionID = Date.now();
      const pluginPayU = document.createElement("script");
      pluginPayU.onload = async function() {
        var LRouter = router;
        this.DadosCheckout = JSON.parse(
          sessionStorage.getItem("DadosCheckout")
        );
        LDecripto.paymentData.transaction.order.additionalValues.TX_VALUE.value = parseFloat(
          this.VariantePriceUpSellSelected
        );
        this.getSignature(
          LDecripto.paymentData.transaction.order.additionalValues.TX_VALUE
            .value
        );
        /* ADICIONAR O NOVO PRODUTO - ALTERAR O VALOR,  */

        let LCripto = JSON.stringify(LDecripto);
        LCripto = btoa(LCripto);
        sessionStorage.setItem("LCrypto", LCripto);
        API_CHECKOUT_PAYU.DoPayBackEnd(LCripto)
          .then(retornoPayment => {
            if (
              retornoPayment.data.transactionResponse != undefined &&
              retornoPayment.data.transactionResponse.state.toUpperCase() ==
                "DECLINED"
            ) {
              API_NOTIFICATION.showNotificationW(
                "Oops!",
                "Pagamento Rejeitado. Por favor, tente novamente.",
                "error"
              );
              return;
            }
            var DadosCliente = {
              nome: this.nome_completo,
              dadosCompra: retornoPayment.data
            };
            UTILIS_API.SetDadosClientesSession(DadosCliente);
            LRouter.push("/obrigado-boleto");
            API_NOTIFICATION.HideLoading();
          })
          .catch(error => {
            console.log("Erro ao efetuar o pagamento no PagSeguro", error);
          });
      };
      pluginPayU.setAttribute(
        "src",
        "https://maf.pagosonline.net/ws/fp/tags.js?id=" + SessionID + "80200"
      );
      pluginPayU.async = true;
      document.head.appendChild(pluginPayU);
    },
    sleep(seconds) {
      return new Promise(r => setTimeout(r, seconds));
    },
    randomString(length, chars) {
      var result = "";
      for (var i = length; i > 0; --i)
        result += chars[Math.floor(Math.random() * chars.length)];
      return result;
    },
    getSignature(total) {
      this.reference_id = this.randomString(
        10,
        "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
      );
      this.signature = md5(
        this.DadosCheckout.api_key +
          "~" +
          this.DadosCheckout.merchan_id +
          "~" +
          this.reference_id +
          "~" +
          total +
          "~BRL"
      );
    },
    async comprarComUmClique() {
      API_NOTIFICATION.ShowLoading();
      var LRouter = router;
      let LCripto = sessionStorage.getItem("LCrypto");
      this.DadosCheckout = JSON.parse(sessionStorage.getItem("DadosCheckout"));
      this.produtosCart = [];
      var lpro = await this.pushProducts(
        this.VarianteIDProdutoJSONUpSellSelected,
        this.quantity,
        this.VarianteIDUpSellSelected
      );
      this.produtosCart.push(lpro);
      let LDecripto = atob(LCripto);
      LDecripto = JSON.parse(LDecripto);
      LDecripto.produtos = this.produtosCart;
      if (this.DadosCheckout.gateway == 1) {
        const LReturn = await this.FCheckoutMP(LDecripto);
      } else if (this.DadosCheckout.gateway == 2) {
        const LReturn = await this.FCheckoutPS(LDecripto);
      } else if (this.DadosCheckout.gateway == 3) {
        const LReturn = await this.FCheckoutPayU(LDecripto);
      }
    }
  }
};
</script>
